#!/usr/bin/env bash
#
# Git Credential Helper for Agent Relay Workspaces
#
# This script fetches fresh GitHub tokens from the cloud API gateway.
# Nango handles token refresh, so tokens are always valid.
#
# Usage: git config --global credential.helper /usr/local/bin/git-credential-relay
#
# Environment variables:
#   WORKSPACE_ID      - Required: The workspace ID for token lookup
#   CLOUD_API_URL     - Required: The cloud API base URL
#   WORKSPACE_TOKEN   - Required: Bearer token for API auth
#

set -euo pipefail

# Only handle 'get' operation
if [[ "${1:-}" != "get" ]]; then
  exit 0
fi

# Read input from git (protocol=https, host=github.com, etc.)
declare -A input
while IFS='=' read -r key value; do
  [[ -z "$key" ]] && break
  input["$key"]="$value"
done

# Only provide credentials for github.com
host="${input[host]:-}"
if [[ "$host" != "github.com" ]]; then
  exit 0
fi

# Check required environment variables
if [[ -z "${WORKSPACE_ID:-}" ]]; then
  echo "git-credential-relay: WORKSPACE_ID not set" >&2
  exit 1
fi

if [[ -z "${CLOUD_API_URL:-}" ]]; then
  echo "git-credential-relay: CLOUD_API_URL not set" >&2
  exit 1
fi

if [[ -z "${WORKSPACE_TOKEN:-}" ]]; then
  echo "git-credential-relay: WORKSPACE_TOKEN not set" >&2
  exit 1
fi

# Fetch fresh token from gateway
response=$(curl -sf \
  -H "Authorization: Bearer ${WORKSPACE_TOKEN}" \
  "${CLOUD_API_URL}/api/git/token?workspaceId=${WORKSPACE_ID}" \
  2>/dev/null) || {
  echo "git-credential-relay: Failed to fetch token from gateway" >&2
  exit 1
}

# Parse JSON response
token=$(echo "$response" | grep -o '"token":"[^"]*"' | cut -d'"' -f4)
username=$(echo "$response" | grep -o '"username":"[^"]*"' | cut -d'"' -f4)

if [[ -z "$token" ]]; then
  echo "git-credential-relay: No token in response" >&2
  exit 1
fi

# Output credentials in git credential format
echo "protocol=https"
echo "host=github.com"
echo "username=${username:-x-access-token}"
echo "password=${token}"

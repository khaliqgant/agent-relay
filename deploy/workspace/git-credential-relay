#!/usr/bin/env bash
#
# Git Credential Helper for Agent Relay Workspaces
#
# This script fetches fresh GitHub tokens from the cloud API gateway.
# Nango handles token refresh, so tokens are always valid.
#
# Usage: git config --global credential.helper /usr/local/bin/git-credential-relay
#
# Environment variables:
#   WORKSPACE_ID      - Required: The workspace ID for token lookup
#   CLOUD_API_URL     - Required: The cloud API base URL
#   WORKSPACE_TOKEN   - Required: Bearer token for API auth
#

set -euo pipefail

# Debug logging (enable with GIT_CREDENTIAL_DEBUG=1)
debug() {
  if [[ "${GIT_CREDENTIAL_DEBUG:-}" == "1" ]]; then
    echo "git-credential-relay: $*" >&2
  fi
}

debug "Called with args: $*"

# Only handle 'get' operation
if [[ "${1:-}" != "get" ]]; then
  debug "Ignoring non-get operation"
  exit 0
fi

# Read input from git (protocol=https, host=github.com, etc.)
declare -A input
while IFS='=' read -r key value; do
  [[ -z "$key" ]] && break
  input["$key"]="$value"
done

# Only provide credentials for github.com
host="${input[host]:-}"
debug "Host: $host"
if [[ "$host" != "github.com" ]]; then
  debug "Not github.com, skipping"
  exit 0
fi

# Check required environment variables
if [[ -z "${WORKSPACE_ID:-}" ]]; then
  echo "git-credential-relay: WORKSPACE_ID not set" >&2
  echo "git-credential-relay: Hint - check if env vars are passed to agent process" >&2
  exit 1
fi

if [[ -z "${CLOUD_API_URL:-}" ]]; then
  echo "git-credential-relay: CLOUD_API_URL not set" >&2
  exit 1
fi

if [[ -z "${WORKSPACE_TOKEN:-}" ]]; then
  echo "git-credential-relay: WORKSPACE_TOKEN not set" >&2
  exit 1
fi

debug "Fetching token from ${CLOUD_API_URL}/api/git/token?workspaceId=${WORKSPACE_ID}"

# Fetch fresh token from gateway (capture stderr for debugging)
http_code=""
response=""
if [[ "${GIT_CREDENTIAL_DEBUG:-}" == "1" ]]; then
  # With debug, show full curl output
  response=$(curl -sf -w "\n%{http_code}" \
    -H "Authorization: Bearer ${WORKSPACE_TOKEN}" \
    "${CLOUD_API_URL}/api/git/token?workspaceId=${WORKSPACE_ID}" \
    2>&1) || true
  http_code="${response##*$'\n'}"
  response="${response%$'\n'*}"
  debug "HTTP response code: $http_code"
  debug "Response: ${response:0:200}"
else
  response=$(curl -sf \
    -H "Authorization: Bearer ${WORKSPACE_TOKEN}" \
    "${CLOUD_API_URL}/api/git/token?workspaceId=${WORKSPACE_ID}" \
    2>/dev/null) || true
fi

if [[ -z "$response" ]]; then
  echo "git-credential-relay: Failed to fetch token from gateway" >&2
  echo "git-credential-relay: Check that CLOUD_API_URL is accessible: ${CLOUD_API_URL}" >&2
  exit 1
fi

# Parse JSON response using jq (more robust than grep)
# Prefer userToken for git operations (works with credential helpers)
# Fall back to token field (which is also userToken-first since the API change)
token=$(echo "$response" | jq -r '.userToken // .token // empty')
username=$(echo "$response" | jq -r '.username // "x-access-token"')
token_type=$(echo "$response" | jq -r '.tokenType // "unknown"')
debug "Token type: $token_type"

if [[ -z "$token" ]]; then
  # Check if there's an error message with details
  error=$(echo "$response" | jq -r '.error // empty')
  code=$(echo "$response" | jq -r '.code // empty')
  hint=$(echo "$response" | jq -r '.hint // empty')
  details=$(echo "$response" | jq -r '.details // empty')

  if [[ -n "$error" ]]; then
    echo "git-credential-relay: ERROR: $error" >&2
    if [[ -n "$code" ]]; then
      echo "git-credential-relay: Code: $code" >&2
    fi
    if [[ -n "$hint" ]]; then
      echo "git-credential-relay: Hint: $hint" >&2
    fi
    if [[ -n "$details" ]]; then
      echo "git-credential-relay: Details: $details" >&2
    fi
  else
    echo "git-credential-relay: No token in response" >&2
    debug "Raw response: $response"
  fi
  exit 1
fi

# Output credentials in git credential format
echo "protocol=https"
echo "host=github.com"
echo "username=${username:-x-access-token}"
echo "password=${token}"

# CLI OAuth Flow Test Container - Real CLIs
#
# This container installs the actual AI provider CLIs and tests
# URL extraction from their OAuth flows.
#
# Installation methods match deploy/workspace/Dockerfile to ensure consistency.
#
# Usage:
#   docker build -f Dockerfile.real -t cli-oauth-test-real scripts/test-cli-auth/
#   docker run --rm cli-oauth-test-real
#
# For interactive testing:
#   docker run --rm -it cli-oauth-test-real bash

FROM node:20-slim

# Install system dependencies (matches deploy/workspace/Dockerfile)
RUN apt-get update && apt-get install -y \
    bash \
    ca-certificates \
    curl \
    git \
    python3 \
    make \
    g++ \
    jq \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /app

# Install Codex globally as root (matches workspace Dockerfile)
RUN npm install -g @openai/codex || echo "Codex install failed"

# Install Gemini CLI globally as root (npm -g requires root)
RUN npm install -g @google/gemini-cli || echo "Gemini install failed"

# Create test user (CLIs install to ~/.local/bin)
RUN useradd -m -u 1001 testuser
RUN chown -R testuser:testuser /app
USER testuser

# Install AI CLIs as testuser (these install scripts write to ~/.local/bin)

# Claude - uses official install script
RUN curl -fsSL https://claude.ai/install.sh | bash || echo "Claude install failed"
# Pre-seed Claude config to skip interactive onboarding
RUN mkdir -p /home/testuser/.claude && \
    echo '{"theme":"dark","hasCompletedOnboarding":true}' > /home/testuser/.claude/settings.local.json

# OpenCode - uses official install script (installs to ~/.local/bin)
RUN curl -fsSL https://opencode.ai/install | bash || echo "OpenCode install failed"

# Droid - uses official install script
RUN curl -fsSL https://app.factory.ai/cli | sh || echo "Droid install failed"

# Add user's local bin to PATH
ENV PATH="/home/testuser/.local/bin:$PATH"

# Copy test files and source dependencies
# Context is repo root, so paths are relative to that
COPY --chown=testuser:testuser scripts/test-cli-auth/ci-test-real-clis.ts /app/
COPY --chown=testuser:testuser scripts/test-cli-auth/package.json /app/

# Copy the cli-pty-runner module to /app/ so it can access node_modules
COPY --chown=testuser:testuser src/cloud/api/cli-pty-runner.ts /app/

# Install test dependencies
RUN npm install

# Verify which CLIs are installed
RUN echo "=== Installed CLIs ===" && \
    (which claude && claude --version 2>&1 | head -1) || echo "claude: not found" && \
    (which codex && codex --version 2>&1 | head -1) || echo "codex: not found" && \
    (which gemini && gemini --version 2>&1 | head -1) || echo "gemini: not found" && \
    (which opencode && opencode --version 2>&1 | head -1) || echo "opencode: not found" && \
    (which droid && droid --version 2>&1 | head -1) || echo "droid: not found"

# Default command runs the CI tests
CMD ["npx", "tsx", "/app/ci-test-real-clis.ts"]

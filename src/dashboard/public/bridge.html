<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Agent Relay - Bridge</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
    /* ========================================
       Design Tokens (matching index.html)
       ======================================== */
    :root {
      /* Background colors */
      --bg-workspace: #1a1d21;
      --bg-sidebar: #19171d;
      --bg-channel-active: #1164a3;
      --bg-channel-hover: rgba(255, 255, 255, 0.04);
      --bg-main: #222529;
      --bg-message-hover: rgba(255, 255, 255, 0.03);
      --bg-card: #2a2d32;
      --bg-card-hover: #32363c;

      /* Text colors */
      --text-primary: #d1d2d3;
      --text-secondary: #ababad;
      --text-muted: #8d8d8e;
      --text-channel: #bcabbc;
      --text-channel-active: #ffffff;
      --text-link: #1d9bd1;

      /* Accent colors */
      --accent-primary: #1264a3;
      --accent-green: #2bac76;
      --accent-yellow: #e8a427;
      --accent-red: #e01e5a;
      --accent-purple: #7c3aed;

      /* Status colors */
      --status-online: #2bac76;
      --status-away: #e8a427;
      --status-offline: #616061;

      /* Border colors */
      --border-subtle: rgba(255, 255, 255, 0.1);
      --border-divider: rgba(255, 255, 255, 0.06);

      /* Dimensions */
      --sidebar-width: 260px;
      --header-height: 49px;

      /* Typography */
      --font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      --font-mono: 'JetBrains Mono', ui-monospace, monospace;

      /* Transitions */
      --transition-fast: 0.1s ease;
      --transition-normal: 0.2s ease;
    }

    /* ========================================
       Reset & Base
       ======================================== */
    *, *::before, *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html, body {
      height: 100%;
      overflow: hidden;
    }

    body {
      font-family: var(--font-family);
      font-size: 15px;
      line-height: 1.46668;
      color: var(--text-primary);
      background: var(--bg-workspace);
      -webkit-font-smoothing: antialiased;
    }

    /* ========================================
       Layout Structure
       ======================================== */
    .app-container {
      display: flex;
      height: 100vh;
      width: 100vw;
    }

    /* Sidebar */
    .sidebar {
      width: var(--sidebar-width);
      background: var(--bg-sidebar);
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
      border-right: 1px solid var(--border-divider);
    }

    /* Main Content */
    .main-panel {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-width: 0;
      background: var(--bg-main);
    }

    /* ========================================
       Sidebar Components
       ======================================== */
    .workspace-header {
      height: var(--header-height);
      padding: 0 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid var(--border-divider);
      flex-shrink: 0;
    }

    .workspace-name {
      font-size: 18px;
      font-weight: 700;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .workspace-name .status-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--status-online);
      flex-shrink: 0;
    }

    .workspace-name .status-dot.offline {
      background: var(--status-offline);
    }

    /* Command Palette Trigger */
    .search-bar {
      margin: 12px 12px 8px;
      padding: 6px 12px;
      background: rgba(255, 255, 255, 0.06);
      border: 1px solid transparent;
      border-radius: 6px;
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      transition: all var(--transition-fast);
    }

    .search-bar:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    .search-bar svg {
      width: 16px;
      height: 16px;
      color: var(--text-muted);
    }

    .search-bar span {
      font-size: 13px;
      color: var(--text-muted);
      flex: 1;
    }

    .search-bar kbd {
      font-family: var(--font-family);
      font-size: 11px;
      color: var(--text-muted);
      background: rgba(255, 255, 255, 0.1);
      padding: 2px 6px;
      border-radius: 4px;
    }

    .sidebar-content {
      flex: 1;
      overflow-y: auto;
      padding: 12px 0;
    }

    .section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 16px 0 12px;
      height: 26px;
      cursor: pointer;
    }

    .section-header:hover {
      background: var(--bg-channel-hover);
    }

    .section-title {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 15px;
      color: var(--text-channel);
    }

    .section-title svg {
      width: 10px;
      height: 10px;
      opacity: 0.7;
    }

    .section-count {
      font-size: 12px;
      color: var(--text-muted);
      font-family: var(--font-mono);
    }

    .project-list {
      list-style: none;
      padding: 4px 8px;
    }

    .project-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 8px;
      border-radius: 6px;
      cursor: pointer;
      transition: background var(--transition-fast);
    }

    .project-item:hover {
      background: var(--bg-channel-hover);
    }

    .project-item.active {
      background: var(--bg-channel-active);
    }

    .project-item.active .project-name {
      color: var(--text-channel-active);
    }

    .project-status-dot {
      width: 9px;
      height: 9px;
      border-radius: 50%;
      background: var(--status-offline);
      flex-shrink: 0;
    }

    .project-item.connected .project-status-dot {
      background: var(--status-online);
    }

    .project-name {
      font-size: 15px;
      color: var(--text-channel);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      flex: 1;
    }

    .project-dashboard-btn {
      width: 24px;
      height: 24px;
      border: none;
      background: transparent;
      color: var(--text-muted);
      cursor: pointer;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: all var(--transition-fast);
    }

    .project-item:hover .project-dashboard-btn {
      opacity: 1;
    }

    .project-dashboard-btn:hover {
      background: rgba(255, 255, 255, 0.15);
      color: var(--text-primary);
    }

    .project-dashboard-btn svg {
      width: 14px;
      height: 14px;
    }

    .sidebar-footer {
      padding: 12px 16px;
      border-top: 1px solid var(--border-divider);
    }

    .nav-link {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 8px;
      color: var(--text-channel);
      text-decoration: none;
      font-size: 15px;
      border-radius: 6px;
      transition: background var(--transition-fast);
    }

    .nav-link:hover {
      background: var(--bg-channel-hover);
    }

    .nav-link svg {
      width: 18px;
      height: 18px;
      opacity: 0.7;
    }

    /* ========================================
       Main Panel Header
       ======================================== */
    .channel-header {
      height: var(--header-height);
      padding: 0 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid var(--border-divider);
      flex-shrink: 0;
    }

    .channel-info {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .channel-name {
      font-size: 18px;
      font-weight: 700;
      color: var(--text-primary);
    }

    .channel-stats {
      display: flex;
      gap: 16px;
    }

    .stat-badge {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      background: rgba(255, 255, 255, 0.06);
      border-radius: 12px;
      font-size: 13px;
      color: var(--text-secondary);
    }

    .stat-badge .value {
      font-weight: 600;
      color: var(--text-primary);
      font-family: var(--font-mono);
    }

    /* ========================================
       Project Cards Grid
       ======================================== */
    .cards-container {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
    }

    .cards-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
      gap: 16px;
    }

    .project-card {
      background: var(--bg-card);
      border: 1px solid var(--border-divider);
      border-radius: 8px;
      padding: 16px;
      transition: all var(--transition-normal);
    }

    .project-card:hover {
      background: var(--bg-card-hover);
      border-color: var(--border-subtle);
    }

    .project-card.offline {
      opacity: 0.6;
    }

    .project-card.selected {
      border-color: var(--accent-primary);
      background: var(--bg-card-hover);
    }

    .project-card {
      cursor: pointer;
    }

    /* Header with back link */
    .back-link {
      color: var(--text-link);
      cursor: pointer;
      font-size: 13px;
      font-weight: 400;
      margin-right: 8px;
    }

    .back-link:hover {
      text-decoration: underline;
    }

    .project-title {
      color: var(--text-primary);
    }

    .card-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      margin-bottom: 12px;
    }

    .card-title-group {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .card-icon {
      width: 36px;
      height: 36px;
      background: var(--accent-primary);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
    }

    .card-icon svg {
      width: 18px;
      height: 18px;
    }

    .card-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .card-path {
      font-size: 12px;
      font-family: var(--font-mono);
      color: var(--text-muted);
      margin-top: 2px;
    }

    .card-status {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 500;
    }

    .card-status.online {
      background: rgba(43, 172, 118, 0.15);
      color: var(--status-online);
    }

    .card-status.offline {
      background: rgba(97, 96, 97, 0.15);
      color: var(--status-offline);
    }

    .card-status.reconnecting {
      background: rgba(232, 164, 39, 0.15);
      color: var(--status-away);
    }

    .card-status.reconnecting .dot {
      animation: pulse-glow 1.5s ease-in-out infinite;
    }

    .card-status .dot {
      width: 6px;
      height: 6px;
      background: currentColor;
      border-radius: 50%;
    }

    /* Agent List in Card */
    .agents-section {
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid var(--border-divider);
    }

    .agents-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
    }

    .agents-label {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .agents-count {
      font-size: 12px;
      font-family: var(--font-mono);
      color: var(--text-muted);
    }

    .agents-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .agent-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 8px;
      background: rgba(255, 255, 255, 0.03);
      border-radius: 6px;
    }

    .agent-status-dot {
      width: 8px;
      height: 8px;
      background: var(--status-online);
      border-radius: 50%;
    }

    .agent-name {
      font-size: 14px;
      font-weight: 500;
      color: var(--text-primary);
    }

    .agent-cli {
      margin-left: auto;
      font-size: 12px;
      font-family: var(--font-mono);
      color: var(--text-muted);
    }

    .no-agents {
      padding: 12px;
      text-align: center;
      font-size: 13px;
      color: var(--text-muted);
      background: rgba(255, 255, 255, 0.02);
      border-radius: 6px;
    }

    .card-actions {
      display: flex;
      gap: 8px;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid var(--border-divider);
    }

    .card-action-btn {
      flex: 1;
      padding: 8px 12px;
      background: rgba(255, 255, 255, 0.06);
      border: 1px solid var(--border-subtle);
      border-radius: 6px;
      color: var(--text-secondary);
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      transition: all var(--transition-fast);
    }

    .card-action-btn:hover {
      background: rgba(255, 255, 255, 0.1);
      color: var(--text-primary);
      border-color: var(--accent-primary);
    }

    .card-action-btn.primary {
      background: var(--accent-primary);
      border-color: var(--accent-primary);
      color: white;
    }

    .card-action-btn.primary:hover {
      background: #0d4f7a;
    }

    .card-action-btn svg {
      width: 14px;
      height: 14px;
    }

    /* Empty State */
    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      padding: 48px;
      text-align: center;
    }

    .empty-icon {
      width: 64px;
      height: 64px;
      background: var(--bg-card);
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 16px;
      color: var(--text-muted);
    }

    .empty-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 8px;
    }

    .empty-text {
      font-size: 14px;
      color: var(--text-muted);
      max-width: 300px;
      margin-bottom: 16px;
    }

    .empty-code {
      font-family: var(--font-mono);
      font-size: 13px;
      padding: 10px 14px;
      background: var(--bg-card);
      border-radius: 6px;
      color: var(--accent-green);
    }

    /* ========================================
       Messages Panel
       ======================================== */
    .messages-panel {
      width: 360px;
      background: var(--bg-sidebar);
      border-left: 1px solid var(--border-divider);
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
    }

    .messages-header {
      height: var(--header-height);
      padding: 0 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid var(--border-divider);
    }

    .messages-title {
      font-size: 16px;
      font-weight: 700;
      color: var(--text-primary);
    }

    .live-indicator {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      color: var(--status-online);
    }

    .live-indicator .dot {
      width: 6px;
      height: 6px;
      background: var(--status-online);
      border-radius: 50%;
      animation: pulse 2s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.4; }
    }

    .messages-list {
      flex: 1;
      overflow-y: auto;
      padding: 12px;
    }

    .message-item {
      padding: 10px 12px;
      background: var(--bg-main);
      border-radius: 8px;
      margin-bottom: 8px;
    }

    .message-item:hover {
      background: var(--bg-card);
    }

    .message-route {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 6px;
      font-size: 12px;
    }

    .route-tag {
      padding: 2px 6px;
      background: rgba(255, 255, 255, 0.08);
      border-radius: 4px;
      font-family: var(--font-mono);
      color: var(--text-secondary);
    }

    .route-agent {
      font-weight: 500;
      color: var(--text-primary);
    }

    .route-arrow {
      color: var(--text-muted);
    }

    .route-time {
      margin-left: auto;
      font-family: var(--font-mono);
      color: var(--text-muted);
      font-size: 11px;
    }

    .message-body {
      font-size: 13px;
      color: var(--text-secondary);
      line-height: 1.4;
      word-wrap: break-word;
      white-space: pre-wrap;
    }

    .messages-empty {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: var(--text-muted);
      font-size: 13px;
    }

    /* Message Composer */
    .message-composer {
      padding: 12px 16px;
      border-top: 1px solid var(--border-divider);
      background: var(--bg-sidebar);
    }

    .composer-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
    }

    .composer-label {
      font-size: 12px;
      color: var(--text-muted);
    }

    .composer-select {
      flex: 1;
      padding: 6px 10px;
      font-size: 13px;
      font-family: var(--font-family);
      color: var(--text-primary);
      background: var(--bg-main);
      border: 1px solid var(--border-subtle);
      border-radius: 4px;
      cursor: pointer;
    }

    .composer-select:hover {
      border-color: var(--accent-primary);
    }

    .composer-select:focus {
      outline: none;
      border-color: var(--accent-primary);
    }

    .composer-select:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .composer-select option {
      background: #222529;
      color: #d1d2d3;
      padding: 8px;
    }

    .composer-select option:hover,
    .composer-select option:checked {
      background: #1164a3;
      color: #fff;
    }

    .composer-input-row {
      display: flex;
      gap: 8px;
    }

    .composer-input {
      flex: 1;
      padding: 8px 12px;
      font-size: 14px;
      font-family: var(--font-family);
      color: var(--text-primary);
      background: var(--bg-main);
      border: 1px solid var(--border-subtle);
      border-radius: 6px;
    }

    .composer-input:hover:not(:disabled) {
      border-color: var(--accent-primary);
    }

    .composer-input:focus {
      outline: none;
      border-color: var(--accent-primary);
    }

    .composer-input:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .composer-input::placeholder {
      color: var(--text-muted);
    }

    .composer-send {
      padding: 8px 12px;
      background: var(--accent-primary);
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: var(--transition-fast);
    }

    .composer-send:hover:not(:disabled) {
      background: #0d4f7a;
    }

    .composer-send:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .composer-status {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 6px;
      min-height: 16px;
    }

    .composer-status.success {
      color: var(--status-online);
    }

    .composer-status.error {
      color: var(--accent-red);
    }

    .messages-footer {
      padding: 12px 16px;
      border-top: 1px solid var(--border-divider);
      display: flex;
      justify-content: space-between;
      font-size: 12px;
      font-family: var(--font-mono);
      color: var(--text-muted);
    }

    /* ========================================
       Command Palette
       ======================================== */
    .command-palette-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.6);
      display: none;
      align-items: flex-start;
      justify-content: center;
      padding-top: 15vh;
      z-index: 1000;
    }

    .command-palette-overlay.visible {
      display: flex;
    }

    .command-palette {
      width: 600px;
      max-width: 90vw;
      background: var(--bg-sidebar);
      border-radius: 8px;
      box-shadow: 0 18px 50px rgba(0, 0, 0, 0.6);
      overflow: hidden;
      animation: paletteSlideIn 0.15s ease-out;
    }

    @keyframes paletteSlideIn {
      from {
        opacity: 0;
        transform: translateY(-10px) scale(0.98);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    .palette-search {
      padding: 16px;
      border-bottom: 1px solid var(--border-divider);
    }

    .palette-search-input {
      width: 100%;
      background: transparent;
      border: none;
      color: var(--text-primary);
      font-family: var(--font-family);
      font-size: 18px;
      outline: none;
    }

    .palette-search-input::placeholder {
      color: var(--text-muted);
    }

    .palette-results {
      max-height: 400px;
      overflow-y: auto;
    }

    .palette-section {
      padding: 8px 0;
    }

    .palette-section-title {
      padding: 8px 16px 4px;
      font-size: 12px;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .palette-item {
      padding: 10px 16px;
      display: flex;
      align-items: center;
      gap: 12px;
      cursor: pointer;
      transition: background var(--transition-fast);
    }

    .palette-item:hover,
    .palette-item.selected {
      background: rgba(255, 255, 255, 0.06);
    }

    .palette-item-icon {
      width: 20px;
      height: 20px;
      color: var(--text-muted);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .palette-item-content {
      flex: 1;
    }

    .palette-item-title {
      font-size: 14px;
      color: var(--text-primary);
    }

    .palette-item-subtitle {
      font-size: 12px;
      color: var(--text-muted);
    }

    .palette-item-shortcut {
      font-size: 12px;
      color: var(--text-muted);
    }

    .palette-item-shortcut kbd {
      font-family: var(--font-family);
      background: rgba(255, 255, 255, 0.1);
      padding: 2px 6px;
      border-radius: 3px;
    }

    /* ========================================
       Scrollbars
       ======================================== */
    ::-webkit-scrollbar {
      width: 8px;
    }

    ::-webkit-scrollbar-track {
      background: transparent;
    }

    ::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    /* ========================================
       Spawn Agent Modal
       ======================================== */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.7);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1100;
    }

    .modal-overlay.visible {
      display: flex;
    }

    .modal {
      background: var(--bg-sidebar);
      border-radius: 12px;
      box-shadow: 0 18px 50px rgba(0, 0, 0, 0.6);
      width: 440px;
      max-width: 90vw;
      animation: modalSlideIn 0.2s ease-out;
    }

    @keyframes modalSlideIn {
      from { opacity: 0; transform: scale(0.95) translateY(-10px); }
      to { opacity: 1; transform: scale(1) translateY(0); }
    }

    .modal-header {
      padding: 20px 24px 16px;
      border-bottom: 1px solid var(--border-divider);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .modal-title {
      font-size: 18px;
      font-weight: 700;
      color: var(--text-primary);
    }

    .modal-close {
      width: 32px;
      height: 32px;
      border: none;
      background: transparent;
      color: var(--text-muted);
      border-radius: 6px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all var(--transition-fast);
    }

    .modal-close:hover {
      background: rgba(255, 255, 255, 0.1);
      color: var(--text-primary);
    }

    .modal-body {
      padding: 20px 24px;
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-group:last-child {
      margin-bottom: 0;
    }

    .form-label {
      display: block;
      font-size: 13px;
      font-weight: 600;
      color: var(--text-secondary);
      margin-bottom: 6px;
    }

    .form-input {
      width: 100%;
      padding: 10px 12px;
      background: var(--bg-main);
      border: 1px solid var(--border-subtle);
      border-radius: 6px;
      color: var(--text-primary);
      font-family: var(--font-family);
      font-size: 14px;
      outline: none;
      transition: border-color var(--transition-fast);
    }

    .form-input:focus {
      border-color: var(--accent-primary);
    }

    .form-input::placeholder {
      color: var(--text-muted);
    }

    .form-select {
      width: 100%;
      padding: 10px 12px;
      background: var(--bg-main);
      border: 1px solid var(--border-subtle);
      border-radius: 6px;
      color: var(--text-primary);
      font-family: var(--font-family);
      font-size: 14px;
      outline: none;
      cursor: pointer;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%23ababad' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
    }

    .form-select:focus {
      border-color: var(--accent-primary);
    }

    .form-hint {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 4px;
    }

    .modal-footer {
      padding: 16px 24px 20px;
      display: flex;
      justify-content: flex-end;
      gap: 12px;
    }

    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      font-family: var(--font-family);
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all var(--transition-fast);
    }

    .btn-secondary {
      background: transparent;
      color: var(--text-secondary);
      border: 1px solid var(--border-subtle);
    }

    .btn-secondary:hover {
      background: rgba(255, 255, 255, 0.05);
      color: var(--text-primary);
    }

    .btn-primary {
      background: var(--accent-primary);
      color: white;
    }

    .btn-primary:hover {
      background: #0b5d99;
    }

    .btn-primary:disabled {
      background: var(--border-subtle);
      cursor: not-allowed;
    }

    /* Spawn button in card */
    .spawn-agent-btn {
      padding: 8px 12px;
      background: rgba(43, 172, 118, 0.15);
      border: 1px solid rgba(43, 172, 118, 0.3);
      border-radius: 6px;
      color: var(--accent-green);
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      transition: all var(--transition-fast);
    }

    .spawn-agent-btn:hover {
      background: rgba(43, 172, 118, 0.25);
      border-color: var(--accent-green);
    }

    .spawn-agent-btn svg {
      width: 14px;
      height: 14px;
    }

    /* Kill button in agent item */
    .agent-kill-btn {
      width: 20px;
      height: 20px;
      border: none;
      background: transparent;
      color: var(--text-muted);
      border-radius: 4px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: all var(--transition-fast);
      margin-left: auto;
    }

    .agent-item:hover .agent-kill-btn {
      opacity: 1;
    }

    .agent-kill-btn:hover {
      background: rgba(224, 30, 90, 0.2);
      color: var(--accent-red);
    }

    .agent-kill-btn svg {
      width: 12px;
      height: 12px;
    }
  </style>
</head>
<body>
  <div class="app-container">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="workspace-header">
        <div class="workspace-name">
          <span class="status-dot" id="status-dot"></span>
          Bridge Mode
        </div>
      </div>

      <div class="search-bar" id="search-bar">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="11" cy="11" r="8"/>
          <line x1="21" y1="21" x2="16.65" y2="16.65"/>
        </svg>
        <span>Search...</span>
        <kbd>⌘K</kbd>
      </div>

      <div class="sidebar-content">
        <div class="section-header">
          <div class="section-title">
            <svg viewBox="0 0 10 10" fill="currentColor"><path d="M5 7L1 3h8z"/></svg>
            Projects
          </div>
          <span class="section-count" id="project-count">0</span>
        </div>
        <ul class="project-list" id="project-list">
          <!-- Projects injected here -->
        </ul>
      </div>

      <div class="sidebar-footer">
        <a href="/" class="nav-link">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M19 12H5M12 19l-7-7 7-7"/>
          </svg>
          Back to Dashboard
        </a>
      </div>
    </aside>

    <!-- Main Panel -->
    <main class="main-panel">
      <header class="channel-header">
        <div class="channel-info">
          <h1 class="channel-name" id="channel-name">All Projects</h1>
        </div>
        <div class="channel-stats">
          <div class="stat-badge">
            <span class="value" id="stat-agents">0</span>
            <span>agents</span>
          </div>
          <div class="stat-badge">
            <span class="value" id="stat-messages">0</span>
            <span>messages</span>
          </div>
        </div>
      </header>

      <div class="cards-container">
        <div class="cards-grid" id="cards-grid">
          <div class="empty-state" id="empty-state">
            <div class="empty-icon">
              <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <path d="M9 3H5a2 2 0 0 0-2 2v4m6-6h10a2 2 0 0 1 2 2v4M9 3v18m0 0h10a2 2 0 0 0 2-2v-4M9 21H5a2 2 0 0 1-2-2v-4m0-6v6"/>
              </svg>
            </div>
            <div class="empty-title">No Projects Connected</div>
            <div class="empty-text">Start the bridge to orchestrate multiple projects</div>
            <code class="empty-code">agent-relay bridge ./proj1 ./proj2</code>
          </div>
        </div>
      </div>
    </main>

    <!-- Messages Panel -->
    <aside class="messages-panel">
      <header class="messages-header">
        <span class="messages-title">Message Flow</span>
        <div class="live-indicator">
          <span class="dot"></span>
          <span>Live</span>
        </div>
      </header>

      <div class="messages-list" id="messages-list">
        <div class="messages-empty">
          <p>No messages yet</p>
        </div>
      </div>

      <!-- Message Composer -->
      <div class="message-composer" id="message-composer">
        <div class="composer-header">
          <span class="composer-label">Send to:</span>
          <select class="composer-select" id="composer-project">
            <option value="">Select a project...</option>
          </select>
          <select class="composer-select" id="composer-agent">
            <option value="">Select agent...</option>
          </select>
        </div>
        <div class="composer-input-row">
          <input
            type="text"
            class="composer-input"
            id="composer-message"
            placeholder="Type a message..."
            disabled
          />
          <button class="composer-send" id="composer-send" disabled>
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="22" y1="2" x2="11" y2="13"/>
              <polygon points="22 2 15 22 11 13 2 9 22 2"/>
            </svg>
          </button>
        </div>
        <div class="composer-status" id="composer-status"></div>
      </div>

      <footer class="messages-footer">
        <span id="uptime">Uptime: --</span>
      </footer>
    </aside>
  </div>

  <!-- Command Palette -->
  <div class="command-palette-overlay" id="command-palette-overlay">
    <div class="command-palette">
      <div class="palette-search">
        <input
          type="text"
          class="palette-search-input"
          id="palette-search"
          placeholder="Search projects, agents, or type a command..."
          autocomplete="off"
        >
      </div>
      <div class="palette-results" id="palette-results">
        <div class="palette-section">
          <div class="palette-section-title">Commands</div>
          <div class="palette-item" data-command="broadcast">
            <div class="palette-item-icon">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/>
                <path d="M15.54 8.46a5 5 0 0 1 0 7.07"/>
                <path d="M19.07 4.93a10 10 0 0 1 0 14.14"/>
              </svg>
            </div>
            <div class="palette-item-content">
              <div class="palette-item-title">/broadcast</div>
              <div class="palette-item-subtitle">Send message to all leads</div>
            </div>
          </div>
          <div class="palette-item" data-command="refresh">
            <div class="palette-item-icon">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M23 4v6h-6"/>
                <path d="M1 20v-6h6"/>
                <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/>
              </svg>
            </div>
            <div class="palette-item-content">
              <div class="palette-item-title">/refresh</div>
              <div class="palette-item-subtitle">Refresh all project data</div>
            </div>
          </div>
        </div>
        <div class="palette-section" id="palette-navigation-section">
          <div class="palette-section-title">Navigation</div>
          <div class="palette-item" data-command="go-dashboard">
            <div class="palette-item-icon">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                <polyline points="9 22 9 12 15 12 15 22"/>
              </svg>
            </div>
            <div class="palette-item-content">
              <div class="palette-item-title">Go to Main Dashboard</div>
              <div class="palette-item-subtitle">View single-project dashboard</div>
            </div>
          </div>
        </div>
        <div class="palette-section" id="palette-projects-section">
          <div class="palette-section-title">Open Project Dashboard</div>
          <!-- Projects injected here -->
        </div>
        <div class="palette-section" id="palette-agents-section">
          <div class="palette-section-title">Message Agent</div>
          <!-- Agents injected here -->
        </div>
      </div>
    </div>
  </div>

  <script>
    // State
    let connectionStart = null;
    let lastDataHash = '';
    let currentData = { projects: [], messages: [] };

    // Elements
    const statusDot = document.getElementById('status-dot');
    const projectList = document.getElementById('project-list');
    const cardsGrid = document.getElementById('cards-grid');
    const emptyState = document.getElementById('empty-state');
    const messagesList = document.getElementById('messages-list');
    const searchBar = document.getElementById('search-bar');
    const paletteOverlay = document.getElementById('command-palette-overlay');
    const paletteSearch = document.getElementById('palette-search');
    const paletteProjectsSection = document.getElementById('palette-projects-section');
    const paletteAgentsSection = document.getElementById('palette-agents-section');

    // Composer elements
    const composerProject = document.getElementById('composer-project');
    const composerAgent = document.getElementById('composer-agent');
    const composerMessage = document.getElementById('composer-message');
    const composerSend = document.getElementById('composer-send');
    const composerStatus = document.getElementById('composer-status');

    // Command Palette
    function openPalette() {
      paletteOverlay.classList.add('visible');
      paletteSearch.value = '';
      paletteSearch.focus();
      updatePaletteResults();
    }

    function closePalette() {
      paletteOverlay.classList.remove('visible');
    }

    function updatePaletteResults() {
      const query = paletteSearch.value.toLowerCase();

      // Update projects section
      const projects = currentData.projects || [];
      const filteredProjects = query
        ? projects.filter(p => (p.name || p.id).toLowerCase().includes(query))
        : projects;

      if (filteredProjects.length > 0) {
        paletteProjectsSection.innerHTML = `
          <div class="palette-section-title">Open Project Dashboard</div>
          ${filteredProjects.map(p => `
            <div class="palette-item" data-project="${escapeHtml(p.id)}" data-action="open-dashboard">
              <div class="palette-item-icon">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                  <line x1="3" y1="9" x2="21" y2="9"/>
                  <line x1="9" y1="21" x2="9" y2="9"/>
                </svg>
              </div>
              <div class="palette-item-content">
                <div class="palette-item-title">${escapeHtml(p.name || p.id)}</div>
                <div class="palette-item-subtitle">${p.connected ? 'Online' : 'Offline'} · ${(p.agents || []).length} agents · Click to open dashboard</div>
              </div>
              <div class="palette-item-shortcut">
                <kbd>⏎</kbd>
              </div>
            </div>
          `).join('')}
        `;
      } else {
        paletteProjectsSection.innerHTML = '<div class="palette-section-title">Open Project Dashboard</div>';
      }

      // Update agents section
      const allAgents = [];
      projects.forEach(p => {
        (p.agents || []).forEach(a => {
          allAgents.push({ ...a, projectName: p.name || p.id, projectId: p.id });
        });
      });
      const filteredAgents = query
        ? allAgents.filter(a => a.name.toLowerCase().includes(query))
        : allAgents;

      if (filteredAgents.length > 0) {
        paletteAgentsSection.innerHTML = `
          <div class="palette-section-title">Jump to Agent</div>
          ${filteredAgents.map(a => `
            <div class="palette-item" data-agent="${escapeHtml(a.name)}" data-project="${escapeHtml(a.projectId)}">
              <div class="palette-item-icon">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                  <circle cx="12" cy="7" r="4"/>
                </svg>
              </div>
              <div class="palette-item-content">
                <div class="palette-item-title">${escapeHtml(a.name)}</div>
                <div class="palette-item-subtitle">${escapeHtml(a.projectName)} · ${escapeHtml(a.cli || 'unknown')}</div>
              </div>
            </div>
          `).join('')}
        `;
      } else {
        paletteAgentsSection.innerHTML = '<div class="palette-section-title">Jump to Agent</div>';
      }
    }

    // Palette event listeners
    searchBar.addEventListener('click', openPalette);

    paletteOverlay.addEventListener('click', (e) => {
      if (e.target === paletteOverlay) closePalette();
    });

    paletteSearch.addEventListener('input', updatePaletteResults);

    document.addEventListener('keydown', (e) => {
      // Cmd/Ctrl + K to open palette
      if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
        e.preventDefault();
        if (paletteOverlay.classList.contains('visible')) {
          closePalette();
        } else {
          openPalette();
        }
      }
      // Escape to close
      if (e.key === 'Escape' && paletteOverlay.classList.contains('visible')) {
        closePalette();
      }
    });

    // Handle palette item clicks
    document.getElementById('palette-results').addEventListener('click', (e) => {
      const item = e.target.closest('.palette-item');
      if (!item) return;

      const command = item.dataset.command;
      const projectId = item.dataset.project;
      const agentName = item.dataset.agent;
      const action = item.dataset.action;

      if (command === 'broadcast') {
        closePalette();
        // Focus on message composer
        composerMessage.focus();
        composerStatus.textContent = 'Select a project and agent to send a message';
      } else if (command === 'refresh') {
        closePalette();
        location.reload();
      } else if (command === 'go-dashboard') {
        closePalette();
        window.location.href = '/';
      } else if (action === 'open-dashboard' && projectId) {
        closePalette();
        // Navigate to project-specific dashboard
        window.location.href = `/project/${encodeURIComponent(projectId)}`;
      } else if (agentName && projectId) {
        closePalette();
        // Pre-select project and agent in composer for messaging
        composerProject.value = projectId;
        updateComposerAgents();
        setTimeout(() => {
          composerAgent.value = agentName;
          updateComposerState();
          composerMessage.focus();
        }, 50);
      } else if (projectId) {
        closePalette();
        // Select project and scroll to card
        selectProject(projectId);
        const card = document.querySelector(`.project-card[data-project-id="${projectId}"]`);
        if (card) card.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
    });

    // Helpers
    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function formatTime(ts) {
      if (!ts) return '';
      return new Date(ts).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }

    // Composer Functions
    function updateComposerProjects() {
      const projects = currentData.projects || [];
      const connectedProjects = projects.filter(p => p.connected);

      // Preserve current selection
      const currentValue = composerProject.value;

      composerProject.innerHTML = '<option value="">Select a project...</option>' +
        connectedProjects.map(p =>
          `<option value="${escapeHtml(p.id)}">${escapeHtml(p.name || p.id)}</option>`
        ).join('');

      // Restore selection if still valid
      if (currentValue && connectedProjects.some(p => p.id === currentValue)) {
        composerProject.value = currentValue;
      } else if (selectedProjectId && connectedProjects.some(p => p.id === selectedProjectId)) {
        // Sync with card selection
        composerProject.value = selectedProjectId;
        updateComposerAgents();
      }
    }

    function updateComposerAgents() {
      const projectId = composerProject.value;
      if (!projectId) {
        composerAgent.innerHTML = '<option value="">Select agent...</option>';
        composerAgent.disabled = true;
        composerMessage.disabled = true;
        composerSend.disabled = true;
        return;
      }

      // Preserve current agent selection
      const currentAgent = composerAgent.value;

      const project = (currentData.projects || []).find(p => p.id === projectId);
      const agents = project?.agents || [];

      composerAgent.innerHTML = '<option value="">Select agent...</option>' +
        '<option value="*">* (Broadcast to all)</option>' +
        '<option value="lead">Lead</option>' +
        agents.map(a =>
          `<option value="${escapeHtml(a.name)}">${escapeHtml(a.name)}</option>`
        ).join('');

      composerAgent.disabled = false;

      // Restore agent selection if still valid
      if (currentAgent) {
        const validAgents = ['*', 'lead', ...agents.map(a => a.name)];
        if (validAgents.includes(currentAgent)) {
          composerAgent.value = currentAgent;
        }
      }
    }

    function updateComposerState() {
      const hasProject = !!composerProject.value;
      const hasAgent = !!composerAgent.value;
      const hasMessage = composerMessage.value.trim().length > 0;

      composerMessage.disabled = !hasProject || !hasAgent;
      composerSend.disabled = !hasProject || !hasAgent || !hasMessage;
    }

    async function sendBridgeMessage() {
      const projectId = composerProject.value;
      const to = composerAgent.value;
      const message = composerMessage.value.trim();

      if (!projectId || !to || !message) return;

      composerSend.disabled = true;
      composerStatus.textContent = 'Sending...';
      composerStatus.className = 'composer-status';

      try {
        const response = await fetch('/api/bridge/send', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ projectId, to, message })
        });

        const result = await response.json();

        if (response.ok && result.success) {
          composerStatus.textContent = 'Message sent!';
          composerStatus.className = 'composer-status success';
          composerMessage.value = '';
          setTimeout(() => {
            composerStatus.textContent = '';
            composerStatus.className = 'composer-status';
          }, 2000);
        } else {
          throw new Error(result.error || 'Failed to send');
        }
      } catch (err) {
        composerStatus.textContent = err.message || 'Failed to send message';
        composerStatus.className = 'composer-status error';
      }

      updateComposerState();
    }

    // Composer event listeners
    composerProject.addEventListener('change', () => {
      updateComposerAgents();
      updateComposerState();
    });

    composerAgent.addEventListener('change', updateComposerState);
    composerMessage.addEventListener('input', updateComposerState);

    composerSend.addEventListener('click', sendBridgeMessage);
    composerMessage.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey && !composerSend.disabled) {
        e.preventDefault();
        sendBridgeMessage();
      }
    });

    // Project selection state
    let selectedProjectId = null;
    const channelName = document.getElementById('channel-name');

    function selectProject(projectId) {
      selectedProjectId = projectId;

      if (projectId) {
        const project = (currentData.projects || []).find(p => p.id === projectId);
        if (project) {
          channelName.innerHTML = `
            <span class="back-link" id="back-to-all">← All Projects</span>
            <span class="project-title">${escapeHtml(project.name || project.id)}</span>
          `;
          // Auto-select project in composer
          composerProject.value = projectId;
          updateComposerAgents();
          updateComposerState();
        }
      } else {
        channelName.textContent = 'All Projects';
        selectedProjectId = null;
      }

      // Update card selection state
      document.querySelectorAll('.project-card').forEach(card => {
        card.classList.toggle('selected', card.dataset.projectId === projectId);
      });
    }

    // Handle project card clicks
    cardsGrid.addEventListener('click', (e) => {
      // Handle "Open Dashboard" button
      const dashboardBtn = e.target.closest('[data-open-dashboard]');
      if (dashboardBtn) {
        e.stopPropagation();
        const projectId = dashboardBtn.dataset.openDashboard;
        if (projectId) {
          window.location.href = `/project/${encodeURIComponent(projectId)}`;
        }
        return;
      }

      // Handle "Message Lead" button
      const messageLeadBtn = e.target.closest('[data-message-lead]');
      if (messageLeadBtn && !messageLeadBtn.disabled) {
        e.stopPropagation();
        const projectId = messageLeadBtn.dataset.messageLead;
        if (projectId) {
          // Pre-select project and lead in composer
          composerProject.value = projectId;
          updateComposerAgents();
          setTimeout(() => {
            composerAgent.value = 'lead';
            updateComposerState();
            composerMessage.focus();
          }, 50);
        }
        return;
      }

      const card = e.target.closest('.project-card');
      if (card) {
        selectProject(card.dataset.projectId);
      }
    });

    // Handle back link click
    channelName.addEventListener('click', (e) => {
      if (e.target.id === 'back-to-all' || e.target.classList.contains('back-link')) {
        selectProject(null);
      }
    });

    // Handle sidebar project clicks
    projectList.addEventListener('click', (e) => {
      // Check if dashboard button was clicked
      const dashboardBtn = e.target.closest('.project-dashboard-btn');
      if (dashboardBtn) {
        e.stopPropagation();
        const projectId = dashboardBtn.dataset.dashboardProject;
        if (projectId) {
          window.location.href = `/project/${encodeURIComponent(projectId)}`;
        }
        return;
      }

      const item = e.target.closest('.project-item');
      if (item) {
        selectProject(item.dataset.projectId);
      }
    });

    function formatUptime(ms) {
      const seconds = Math.floor(ms / 1000);
      if (seconds < 60) return `${seconds}s`;
      const minutes = Math.floor(seconds / 60);
      if (minutes < 60) return `${minutes}m`;
      const hours = Math.floor(minutes / 60);
      return `${hours}h ${minutes % 60}m`;
    }

    // Update connection status
    function updateConnectionStatus(connected) {
      statusDot.classList.toggle('offline', !connected);
    }

    // Render sidebar projects
    function renderSidebarProjects(projects) {
      if (!projects || projects.length === 0) {
        projectList.innerHTML = '<li class="project-item" style="cursor: default; color: var(--text-muted);">No projects</li>';
        document.getElementById('project-count').textContent = '0';
        return;
      }

      document.getElementById('project-count').textContent = projects.length;

      projectList.innerHTML = projects.map(p => `
        <li class="project-item ${p.connected ? 'connected' : ''} ${selectedProjectId === p.id ? 'active' : ''}" data-project-id="${escapeHtml(p.id)}">
          <span class="project-status-dot"></span>
          <span class="project-name">${escapeHtml(p.name || p.id)}</span>
          <button class="project-dashboard-btn" data-dashboard-project="${escapeHtml(p.id)}" title="Open project dashboard">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
              <line x1="3" y1="9" x2="21" y2="9"/>
              <line x1="9" y1="21" x2="9" y2="9"/>
            </svg>
          </button>
        </li>
      `).join('');
    }

    // Render project cards
    function renderProjectCards(projects) {
      if (!projects || projects.length === 0) {
        cardsGrid.innerHTML = '';
        cardsGrid.appendChild(emptyState);
        emptyState.style.display = 'flex';
        return;
      }

      emptyState.style.display = 'none';

      cardsGrid.innerHTML = projects.map(p => {
        const agents = p.agents || [];
        const agentsHtml = agents.length > 0
          ? agents.map(a => `
              <div class="agent-item">
                <span class="agent-status-dot"></span>
                <span class="agent-name">${escapeHtml(a.name)}</span>
                <span class="agent-cli">${escapeHtml(a.cli || '')}</span>
                <button class="agent-kill-btn" data-agent-name="${escapeHtml(a.name)}" data-project-id="${escapeHtml(p.id)}" title="Kill agent">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"/>
                    <line x1="6" y1="6" x2="18" y2="18"/>
                  </svg>
                </button>
              </div>
            `).join('')
          : '<div class="no-agents">No agents connected</div>';

        const isSelected = selectedProjectId === p.id;
        return `
          <div class="project-card ${p.connected ? '' : 'offline'} ${isSelected ? 'selected' : ''}" data-project-id="${escapeHtml(p.id)}">
            <div class="card-header">
              <div class="card-title-group">
                <div class="card-icon">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/>
                  </svg>
                </div>
                <div>
                  <div class="card-title">${escapeHtml(p.name || p.id)}</div>
                  <div class="card-path">${escapeHtml(p.path || '')}</div>
                </div>
              </div>
              <div class="card-status ${p.connected ? 'online' : p.reconnecting ? 'reconnecting' : 'offline'}">
                <span class="dot"></span>
                <span>${p.connected ? 'Online' : p.reconnecting ? 'Reconnecting...' : 'Offline'}</span>
              </div>
            </div>

            <div class="agents-section">
              <div class="agents-header">
                <span class="agents-label">Agents</span>
                <span class="agents-count">${agents.length} active</span>
              </div>
              <div class="agents-list">
                ${agentsHtml}
              </div>
            </div>

            <div class="card-actions">
              <button class="spawn-agent-btn" data-spawn-project="${escapeHtml(p.id)}" ${!p.connected ? 'disabled' : ''}>
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="12" y1="5" x2="12" y2="19"/>
                  <line x1="5" y1="12" x2="19" y2="12"/>
                </svg>
                Spawn
              </button>
              <button class="card-action-btn" data-message-lead="${escapeHtml(p.id)}" ${!p.connected ? 'disabled' : ''}>
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                </svg>
                Message
              </button>
              <button class="card-action-btn primary" data-open-dashboard="${escapeHtml(p.id)}">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                  <line x1="3" y1="9" x2="21" y2="9"/>
                  <line x1="9" y1="21" x2="9" y2="9"/>
                </svg>
                Dashboard
              </button>
            </div>
          </div>
        `;
      }).join('');
    }

    // Render messages
    function renderMessages(messages) {
      if (!messages || messages.length === 0) {
        messagesList.innerHTML = '<div class="messages-empty"><p>No messages yet</p></div>';
        return;
      }

      messagesList.innerHTML = messages.slice(-50).reverse().map(m => `
        <div class="message-item">
          <div class="message-route">
            <span class="route-tag">${escapeHtml(m.sourceProject || 'local')}</span>
            <span class="route-agent">${escapeHtml(m.from)}</span>
            <span class="route-arrow">→</span>
            <span class="route-agent">${escapeHtml(m.to || '*')}</span>
            <span class="route-time">${formatTime(m.timestamp)}</span>
          </div>
          <div class="message-body">${escapeHtml(m.body || '')}</div>
        </div>
      `).join('');
    }

    // Main render
    function render(data) {
      // Store data for command palette
      currentData = data;

      // Count agents across all projects
      let agentsCount = 0;
      (data.projects || []).forEach(p => {
        agentsCount += (p.agents || []).length;
      });

      document.getElementById('stat-agents').textContent = agentsCount;
      document.getElementById('stat-messages').textContent = data.messages?.length || 0;

      renderSidebarProjects(data.projects);
      renderProjectCards(data.projects);
      renderMessages(data.messages);
      updateComposerProjects();
      // Keep agent dropdown in sync if project is selected
      if (composerProject.value) {
        updateComposerAgents();
        updateComposerState();
      }
    }

    // WebSocket connection
    function connect() {
      const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
      const ws = new WebSocket(`${protocol}//${window.location.host}/ws/bridge`);

      ws.onopen = () => {
        connectionStart = Date.now();
        updateConnectionStatus(true);
      };

      ws.onclose = () => {
        updateConnectionStatus(false);
        setTimeout(connect, 3000);
      };

      ws.onerror = () => {
        updateConnectionStatus(false);
      };

      ws.onmessage = (e) => {
        if (e.data === lastDataHash) return;
        lastDataHash = e.data;

        try {
          const data = JSON.parse(e.data);
          render(data);
        } catch (err) {
          console.error('Parse error:', err);
        }
      };
    }

    // Update uptime
    setInterval(() => {
      if (connectionStart) {
        document.getElementById('uptime').textContent = `Uptime: ${formatUptime(Date.now() - connectionStart)}`;
      }
    }, 1000);

    // Start
    connect();
  </script>

  <!-- Spawn Agent Modal -->
  <div class="modal-overlay" id="spawn-modal-overlay">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title">Spawn New Agent</div>
        <button class="modal-close" id="spawn-modal-close" title="Close">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"/>
            <line x1="6" y1="6" x2="18" y2="18"/>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="spawn-project-id">
        <div class="form-group">
          <label class="form-label" for="spawn-agent-name">Agent Name</label>
          <input type="text" id="spawn-agent-name" class="form-input" placeholder="e.g., Worker, Reviewer, Tester" autocomplete="off">
        </div>
        <div class="form-group">
          <label class="form-label" for="spawn-agent-cli">CLI Tool</label>
          <select id="spawn-agent-cli" class="form-select">
            <option value="claude">Claude</option>
            <option value="codex">Codex</option>
            <option value="gemini">Gemini</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label" for="spawn-agent-model">Model (optional)</label>
          <input type="text" id="spawn-agent-model" class="form-input" placeholder="e.g., opus, sonnet, gpt-4">
          <div class="form-hint">Leave blank to use default model for the CLI</div>
        </div>
        <div class="form-group">
          <label class="form-label" for="spawn-agent-task">Initial Task (optional)</label>
          <textarea id="spawn-agent-task" class="form-input" rows="3" placeholder="Describe what this agent should work on..."></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" id="spawn-modal-cancel">Cancel</button>
        <button class="btn btn-primary" id="spawn-modal-submit">Spawn Agent</button>
      </div>
    </div>
  </div>

  <script>
    // Spawn Modal Functions
    const spawnModalOverlay = document.getElementById('spawn-modal-overlay');
    const spawnProjectIdInput = document.getElementById('spawn-project-id');
    const spawnNameInput = document.getElementById('spawn-agent-name');
    const spawnCliSelect = document.getElementById('spawn-agent-cli');
    const spawnModelInput = document.getElementById('spawn-agent-model');
    const spawnTaskInput = document.getElementById('spawn-agent-task');
    const spawnSubmitBtn = document.getElementById('spawn-modal-submit');

    function openSpawnModal(projectId) {
      spawnProjectIdInput.value = projectId || '';
      spawnModalOverlay.classList.add('visible');
      spawnNameInput.focus();
    }

    function closeSpawnModal() {
      spawnModalOverlay.classList.remove('visible');
      spawnNameInput.value = '';
      spawnCliSelect.value = 'claude';
      spawnModelInput.value = '';
      spawnTaskInput.value = '';
    }

    async function handleSpawnAgent() {
      const projectId = spawnProjectIdInput.value;
      const name = spawnNameInput.value.trim();
      const cli = spawnCliSelect.value;
      const model = spawnModelInput.value.trim();
      const task = spawnTaskInput.value.trim();

      if (!name) {
        alert('Please enter an agent name');
        return;
      }

      spawnSubmitBtn.textContent = 'Spawning...';
      spawnSubmitBtn.disabled = true;

      try {
        const response = await fetch('/api/agent/spawn', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            name,
            cli,
            model: model || undefined,
            task: task || undefined,
            projectId: projectId || undefined,
          }),
        });

        const result = await response.json();

        if (response.ok && result.success) {
          closeSpawnModal();
        } else {
          alert(result.error || 'Failed to spawn agent');
        }
      } catch (err) {
        console.error('Failed to spawn agent:', err);
        alert('Failed to spawn agent');
      } finally {
        spawnSubmitBtn.textContent = 'Spawn Agent';
        spawnSubmitBtn.disabled = false;
      }
    }

    async function killAgent(agentName, projectId) {
      if (!confirm(`Are you sure you want to kill agent "${agentName}"?`)) {
        return;
      }

      try {
        const response = await fetch('/api/agent/kill', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            name: agentName,
            projectId: projectId || undefined,
          }),
        });

        const result = await response.json();
        if (!response.ok) {
          alert(result.error || 'Failed to kill agent');
        }
      } catch (err) {
        console.error('Failed to kill agent:', err);
        alert('Failed to kill agent');
      }
    }

    // Spawn modal event listeners
    document.getElementById('spawn-modal-close').addEventListener('click', closeSpawnModal);
    document.getElementById('spawn-modal-cancel').addEventListener('click', closeSpawnModal);
    spawnSubmitBtn.addEventListener('click', handleSpawnAgent);
    spawnModalOverlay.addEventListener('click', (e) => {
      if (e.target === spawnModalOverlay) closeSpawnModal();
    });
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && spawnModalOverlay.classList.contains('visible')) {
        closeSpawnModal();
      }
    });
    spawnNameInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') handleSpawnAgent();
    });

    // Handle spawn/kill button clicks in cards (event delegation)
    cardsGrid.addEventListener('click', (e) => {
      // Spawn agent button
      const spawnBtn = e.target.closest('[data-spawn-project]');
      if (spawnBtn) {
        e.stopPropagation();
        openSpawnModal(spawnBtn.dataset.spawnProject);
        return;
      }

      // Kill agent button
      const killBtn = e.target.closest('.agent-kill-btn');
      if (killBtn) {
        e.stopPropagation();
        const agentName = killBtn.dataset.agentName;
        const projectId = killBtn.dataset.projectId;
        if (agentName) {
          killAgent(agentName, projectId);
        }
        return;
      }
    });
  </script>

  <!-- Bridge Application (TypeScript bundled) - loaded after inline script for gradual migration -->
  <!-- <script type="module" src="/js/bridge.js"></script> -->
</body>
</html>

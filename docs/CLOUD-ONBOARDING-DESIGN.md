# Agent Relay Cloud - Onboarding Design

## Overview

Agent Relay supports two deployment models with a unified authentication experience:

### Deployment Models

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         AGENT RELAY CLOUD                                    â”‚
â”‚                         (Fully Hosted)                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚   GitHub     â”‚  â”‚  Provider    â”‚  â”‚   Agent      â”‚  â”‚  Dashboard   â”‚    â”‚
â”‚  â”‚   Repos      â”‚  â”‚   Auth       â”‚  â”‚   Execution  â”‚  â”‚   & Logs     â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                              â”‚
â”‚  Everything runs in the cloud. Users just connect accounts.                 â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         SELF-HOSTED                                          â”‚
â”‚                         (Local Execution)                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚  User's Machine / Server                                  â”‚              â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚              â”‚
â”‚  â”‚  â”‚  agent-relay â”‚  â”‚    Agents    â”‚  â”‚   Local      â”‚    â”‚              â”‚
â”‚  â”‚  â”‚  daemon      â”‚  â”‚  (claude,    â”‚  â”‚   Repos      â”‚    â”‚              â”‚
â”‚  â”‚  â”‚              â”‚  â”‚   codex)     â”‚  â”‚              â”‚    â”‚              â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                          â”‚                                                   â”‚
â”‚                          â”‚ Optional: Sync to cloud dashboard                 â”‚
â”‚                          â–¼                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚  Agent Relay Cloud (Optional)                             â”‚              â”‚
â”‚  â”‚  â€¢ Auth management          â€¢ Team collaboration          â”‚              â”‚
â”‚  â”‚  â€¢ Dashboard & logs         â€¢ Credential vault            â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                                                                              â”‚
â”‚  Agents run locally. Cloud is optional for auth/dashboard.                  â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Feature Comparison

| Feature | Cloud Hosted | Self-Hosted | Self-Hosted + Cloud |
|---------|--------------|-------------|---------------------|
| Agent execution | Cloud | Local | Local |
| GitHub integration | âœ… Automatic | Manual clone | âœ… Webhook sync |
| Provider auth | âœ… Device flow | Local login | âœ… Device flow |
| Credential storage | âœ… Vault | Local files | âœ… Vault |
| Dashboard | âœ… Hosted | localhost:3888 | âœ… Synced |
| Team collaboration | âœ… Full | N/A | âœ… Full |
| Offline mode | âŒ | âœ… | âœ… (degraded) |
| Data locality | Cloud | Local | Hybrid |

### When to Use Each

**Cloud Hosted** - Best for:
- Teams wanting zero infrastructure management
- CI/CD integration with GitHub Actions
- Users without local GPU/compute resources

**Self-Hosted** - Best for:
- Air-gapped environments
- Strict data locality requirements
- Users who already have agents installed locally

**Self-Hosted + Cloud** - Best for:
- Teams wanting local execution with cloud collaboration
- Developers who want dashboard/logs without running locally
- Enterprises with hybrid requirements

---

## Cloud Hosted Mode

Agent Relay Cloud (fully hosted) provides:
- Automatic server provisioning with supervisor
- GitHub repository integration
- Multi-provider agent authentication via device flow
- Team management and collaboration
- Centralized dashboard and logs

---

## Self-Hosted Mode

For users running agent-relay locally, authentication can work in two ways:

### Option A: Local Authentication (Fully Offline)

Users authenticate directly with each provider's CLI:

```bash
# Install agent-relay
npm install -g agent-relay

# Authenticate providers locally (each opens browser)
claude /login          # Login to Anthropic
codex                  # Login to OpenAI (first run prompts)

# Start agent-relay with local credentials
agent-relay up
agent-relay -n Alice claude "Start working on the feature"
```

Credentials are stored locally:
- Claude: `~/.claude/.credentials.json` or macOS Keychain
- Codex: `~/.codex/`
- Google: `~/.config/gcloud/`

### Option B: Self-Hosted + Cloud Auth (Hybrid)

Users can optionally connect their local agent-relay to Agent Relay Cloud for:
- Centralized credential management (device flow auth)
- Team collaboration features
- Cloud dashboard with synced logs

```bash
# Install and link to cloud account
npm install -g agent-relay
agent-relay cloud login    # Opens browser, authenticates with cloud

# Cloud handles provider auth, syncs credentials down
agent-relay cloud connect anthropic   # Device flow auth
agent-relay cloud connect openai      # Device flow auth

# Start locally - credentials pulled from cloud
agent-relay up --cloud-sync
agent-relay -n Alice claude "Start working"
```

### Self-Hosted Onboarding Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  agent-relay cloud login                                         â”‚
â”‚                                                                  â”‚
â”‚  Opening browser to authenticate...                             â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚  If browser doesn't open, visit:                            â”‚â”‚
â”‚  â”‚  https://relay.cloud/cli/auth?code=ABCD-1234               â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                  â”‚
â”‚  â³ Waiting for authentication...                               â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  â†“ After successful auth

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  âœ… Authenticated as user@example.com                            â”‚
â”‚                                                                  â”‚
â”‚  Your local agent-relay is now linked to Agent Relay Cloud.    â”‚
â”‚                                                                  â”‚
â”‚  Connected providers:                                           â”‚
â”‚  â€¢ Anthropic (Claude)  âœ… Ready                                 â”‚
â”‚  â€¢ OpenAI (Codex)      âŒ Not connected                         â”‚
â”‚  â€¢ Google (Gemini)     âŒ Not connected                         â”‚
â”‚                                                                  â”‚
â”‚  To connect more providers:                                     â”‚
â”‚    agent-relay cloud connect openai                             â”‚
â”‚    agent-relay cloud connect google                             â”‚
â”‚                                                                  â”‚
â”‚  To start the daemon with cloud sync:                          â”‚
â”‚    agent-relay up --cloud-sync                                  â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Credential Sync Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Agent Relay Cloud                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Credential Vault (encrypted)                             â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚  â”‚
â”‚  â”‚  â”‚Anthropicâ”‚  â”‚ OpenAI  â”‚  â”‚ Google  â”‚                   â”‚  â”‚
â”‚  â”‚  â”‚ tokens  â”‚  â”‚ tokens  â”‚  â”‚ tokens  â”‚                   â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚          â”‚            â”‚            â”‚                            â”‚
â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                            â”‚
â”‚                       â”‚                                          â”‚
â”‚                       â–¼ Encrypted sync                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â”‚ TLS + E2E encrypted
                        â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    User's Machine                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  agent-relay daemon                                       â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚
â”‚  â”‚  â”‚  Local credential cache (encrypted, auto-refresh)  â”‚ â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚
â”‚  â”‚                      â”‚                                    â”‚   â”‚
â”‚  â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚   â”‚
â”‚  â”‚           â–¼          â–¼          â–¼                        â”‚   â”‚
â”‚  â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚   â”‚
â”‚  â”‚      â”‚ claude â”‚ â”‚ codex  â”‚ â”‚ gemini â”‚                   â”‚   â”‚
â”‚  â”‚      â”‚ agent  â”‚ â”‚ agent  â”‚ â”‚ agent  â”‚                   â”‚   â”‚
â”‚  â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Provider Authentication Architecture

### Design Principle: Login-Only Authentication

**No API keys in the UI** - Users authenticate via login flows, not by pasting keys. This provides:

- **Better security**: No keys to leak, rotate, or manage
- **Consistent UX**: Always "Login with X" buttons
- **Account linking**: Users authenticate with their existing provider accounts
- **Automatic token refresh**: Where supported

### Provider Authentication Reality Check

Different providers have different OAuth maturity levels. Notably, **both Claude Code and
OpenAI Codex** use browser-based OAuth that doesn't support headless/cloud environments well:

| Provider | Auth Flow | Status | Notes |
|----------|-----------|--------|-------|
| Claude/Anthropic | Browser OAuth | âš ï¸ Device Flow | Opens browser, no redirect URI support |
| OpenAI/Codex | Browser OAuth | âš ï¸ Device Flow | Opens browser for ChatGPT login |
| Google/Gemini | OAuth 2.0 | âœ… Redirect | Standard Google OAuth with redirect |
| GitHub Copilot | OAuth 2.0 | âœ… Redirect | Via GitHub OAuth (auto from signup) |
| Azure OpenAI | OAuth 2.0 | âœ… Redirect | Via Microsoft Entra ID |
| Local/Self-hosted | None | âœ… N/A | Just endpoint URL |

**Key insight**: The two most popular coding agents (Claude Code and Codex) both require
device flow or similar workarounds for cloud/headless environments. Both have open GitHub
issues requesting proper headless auth support:
- [anthropics/claude-code#7100](https://github.com/anthropics/claude-code/issues/7100)
- [openai/codex#2798](https://github.com/openai/codex/issues/2798)

### Device Flow Authentication Strategy (Claude + Codex)

Both Claude Code and OpenAI Codex use browser-based OAuth that stores tokens locally:
- **Claude Code**: `claude /login` â†’ opens browser â†’ stores in `~/.claude/.credentials.json`
- **Codex**: `codex` â†’ opens browser for ChatGPT â†’ stores in `~/.codex/`

For a cloud environment, we need a **device authorization flow** (RFC 8628):

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Agent Relay Cloud - Claude Code Auth Flow                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  Step 1: User clicks "Login with Anthropic" in our dashboard    â”‚
â”‚          â†“                                                       â”‚
â”‚  Step 2: Opens popup/redirect to Anthropic's OAuth              â”‚
â”‚          (same flow as `claude /login`)                          â”‚
â”‚          â†“                                                       â”‚
â”‚  Step 3: User authenticates with Anthropic                      â”‚
â”‚          â†“                                                       â”‚
â”‚  Step 4: Anthropic redirects back with auth token               â”‚
â”‚          â†“                                                       â”‚
â”‚  Step 5: We store encrypted token in credential vault           â”‚
â”‚          â†“                                                       â”‚
â”‚  Step 6: When spawning agents, inject token via:                â”‚
â”‚          - ANTHROPIC_AUTH_TOKEN env var, or                     â”‚
â”‚          - Mount equivalent of ~/.claude/.credentials.json      â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Note**: This requires Anthropic to support redirect-based OAuth (vs device-only flow). If not available, fallback options:

1. **Device Authorization Flow**: Display code, user enters at anthropic.com
2. **Credential File Upload**: User runs `/login` locally, uploads credential file
3. **API Key (hidden)**: Accept API key but label it as "Access Token" for consistent UX

### Proposed Solution: Provider Credentials Vault

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Agent Relay Cloud                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚   GitHub     â”‚    â”‚  Provider    â”‚    â”‚   Secrets    â”‚       â”‚
â”‚  â”‚   OAuth      â”‚    â”‚  Connector   â”‚    â”‚   Vault      â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚         â”‚                   â”‚                   â”‚                â”‚
â”‚         â–¼                   â–¼                   â–¼                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                  Onboarding Flow                         â”‚    â”‚
â”‚  â”‚  1. Sign up (GitHub OAuth)                              â”‚    â”‚
â”‚  â”‚  2. Connect repositories                                â”‚    â”‚
â”‚  â”‚  3. Add agent providers                                 â”‚    â”‚
â”‚  â”‚  4. Configure teams                                     â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Onboarding Flow Design

### Step 1: Sign Up via GitHub OAuth

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Welcome to Agent Relay Cloud         â”‚
â”‚                                             â”‚
â”‚  Orchestrate AI agents across your repos    â”‚
â”‚                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ðŸ”— Continue with GitHub            â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                             â”‚
â”‚  By signing up, you agree to our Terms     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Why GitHub first?**
- Natural auth for developers
- Immediate access to repo list
- Repository permissions already defined
- GitHub Apps for webhook integration

### Step 2: Connect Repositories

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Select Repositories                                         â”‚
â”‚                                                              â”‚
â”‚  Which repositories should Agent Relay manage?              â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ ðŸ” Search repositories...                              â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                              â”‚
â”‚  â˜‘ï¸  acme/frontend          â­ 234   Updated 2 hours ago    â”‚
â”‚  â˜‘ï¸  acme/backend-api       â­ 156   Updated 1 day ago      â”‚
â”‚  â˜  acme/docs              â­ 45    Updated 3 days ago      â”‚
â”‚  â˜  acme/mobile-app        â­ 89    Updated 1 week ago      â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚    Back      â”‚  â”‚  Continue with 2 repositories  â†’    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**What happens behind the scenes:**
- Install GitHub App on selected repos
- Clone repos to cloud workspace
- Detect existing `.claude/agents/` or `teams.json` configs
- Set up webhooks for PR/issue events

### Step 3: Add Agent Providers (The Key Step)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Connect Your AI Providers                                       â”‚
â”‚                                                                  â”‚
â”‚  Agent Relay works with multiple AI providers. Connect the      â”‚
â”‚  ones you want to use:                                          â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚  ANTHROPIC                                                  â”‚â”‚
â”‚  â”‚  Claude Code                                                â”‚â”‚
â”‚  â”‚  âš¡ Recommended for code tasks                              â”‚â”‚
â”‚  â”‚                                                             â”‚â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚â”‚
â”‚  â”‚  â”‚  ðŸ”  Login with Anthropic                           â”‚   â”‚â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚  OPENAI                                                     â”‚â”‚
â”‚  â”‚  Codex, ChatGPT                                             â”‚â”‚
â”‚  â”‚  Good for diverse tasks                                     â”‚â”‚
â”‚  â”‚                                                             â”‚â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚â”‚
â”‚  â”‚  â”‚  ðŸ”  Login with OpenAI                              â”‚   â”‚â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚  GOOGLE                                                     â”‚â”‚
â”‚  â”‚  Gemini                                                     â”‚â”‚
â”‚  â”‚  Multi-modal capabilities                                   â”‚â”‚
â”‚  â”‚                                                             â”‚â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚â”‚
â”‚  â”‚  â”‚  ðŸ”  Login with Google                              â”‚   â”‚â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚  GITHUB COPILOT                              âœ“ Connected    â”‚â”‚
â”‚  â”‚  Already connected via your GitHub account                  â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚  + Add Self-Hosted Provider                                 â”‚â”‚
â”‚  â”‚  Ollama, LM Studio, or other local tools                    â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                  â”‚
â”‚  You can always add more providers later in Settings            â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚    Skip      â”‚  â”‚  Continue  â†’                            â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### OAuth Login Flow

When user clicks "Login with [Provider]":

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                              â”‚
â”‚       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚       â”‚          provider-name.com              â”‚           â”‚
â”‚       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤           â”‚
â”‚       â”‚                                         â”‚           â”‚
â”‚       â”‚     Sign in to Anthropic                â”‚           â”‚
â”‚       â”‚                                         â”‚           â”‚
â”‚       â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚           â”‚
â”‚       â”‚  â”‚ email@example.com                 â”‚ â”‚           â”‚
â”‚       â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚           â”‚
â”‚       â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚           â”‚
â”‚       â”‚  â”‚ â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢                      â”‚ â”‚           â”‚
â”‚       â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚           â”‚
â”‚       â”‚                                         â”‚           â”‚
â”‚       â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚           â”‚
â”‚       â”‚  â”‚         Sign In                   â”‚ â”‚           â”‚
â”‚       â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚           â”‚
â”‚       â”‚                                         â”‚           â”‚
â”‚       â”‚  Or continue with:                      â”‚           â”‚
â”‚       â”‚  [Google] [GitHub] [SSO]               â”‚           â”‚
â”‚       â”‚                                         â”‚           â”‚
â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

After login, authorization consent:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                              â”‚
â”‚       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚       â”‚                                         â”‚           â”‚
â”‚       â”‚     Authorize Agent Relay Cloud         â”‚           â”‚
â”‚       â”‚                                         â”‚           â”‚
â”‚       â”‚  Agent Relay Cloud wants to:            â”‚           â”‚
â”‚       â”‚                                         â”‚           â”‚
â”‚       â”‚  âœ“ Run AI agents on your behalf         â”‚           â”‚
â”‚       â”‚  âœ“ Access your usage quota              â”‚           â”‚
â”‚       â”‚  âœ“ View your account info               â”‚           â”‚
â”‚       â”‚                                         â”‚           â”‚
â”‚       â”‚  Signed in as: user@example.com         â”‚           â”‚
â”‚       â”‚                                         â”‚           â”‚
â”‚       â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚           â”‚
â”‚       â”‚  â”‚   Cancel    â”‚  â”‚   Authorize     â”‚  â”‚           â”‚
â”‚       â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚           â”‚
â”‚       â”‚                                         â”‚           â”‚
â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

After authorization, redirect back with success:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Connect Your AI Providers                                       â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚  ANTHROPIC                                   âœ“ Connected    â”‚â”‚
â”‚  â”‚  Claude Code                                                â”‚â”‚
â”‚  â”‚  Logged in as claude-user@example.com                       â”‚â”‚
â”‚  â”‚                                             [Disconnect]    â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚  ...                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Device Authorization Flow (RFC 8628)

This is the **primary authentication method** for Claude Code and OpenAI Codex, since neither
supports standard OAuth redirect flows for third-party cloud applications.

### How Device Flow Works

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Agent Relay     â”‚      â”‚   Provider       â”‚      â”‚   User's         â”‚
â”‚  Cloud           â”‚      â”‚   Auth Server    â”‚      â”‚   Browser        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                         â”‚                         â”‚
         â”‚  1. POST /device/code   â”‚                         â”‚
         â”‚  {client_id, scope}     â”‚                         â”‚
         â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                         â”‚
         â”‚                         â”‚                         â”‚
         â”‚  {device_code,          â”‚                         â”‚
         â”‚   user_code: "ABCD-1234"â”‚                         â”‚
         â”‚   verification_uri,     â”‚                         â”‚
         â”‚   expires_in: 900}      â”‚                         â”‚
         â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                         â”‚
         â”‚                         â”‚                         â”‚
         â”‚  Display code to user   â”‚                         â”‚
         â”‚ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€>â”‚
         â”‚                         â”‚                         â”‚
         â”‚                         â”‚  2. User visits URL     â”‚
         â”‚                         â”‚  & enters user_code     â”‚
         â”‚                         â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
         â”‚                         â”‚                         â”‚
         â”‚                         â”‚  3. User authenticates  â”‚
         â”‚                         â”‚  & authorizes app       â”‚
         â”‚                         â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
         â”‚                         â”‚                         â”‚
         â”‚  4. POST /token         â”‚                         â”‚
         â”‚  {device_code}          â”‚                         â”‚
         â”‚  (polling every 5s)     â”‚                         â”‚
         â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                         â”‚
         â”‚                         â”‚                         â”‚
         â”‚  "authorization_pending"â”‚                         â”‚
         â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚  (keep polling...)      â”‚
         â”‚                         â”‚                         â”‚
         â”‚  5. POST /token         â”‚                         â”‚
         â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                         â”‚
         â”‚                         â”‚                         â”‚
         â”‚  {access_token,         â”‚                         â”‚
         â”‚   refresh_token}        â”‚                         â”‚
         â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                         â”‚
         â”‚                         â”‚                         â”‚
```

### Provider-Specific Device Flow URLs

| Provider | Device Code URL | Token URL | Verification URL |
|----------|-----------------|-----------|------------------|
| Anthropic | `api.anthropic.com/oauth/device/code` | `api.anthropic.com/oauth/token` | `console.anthropic.com/device` |
| OpenAI | `auth.openai.com/device/code` | `auth.openai.com/oauth/token` | `auth.openai.com/device` |
| Google | `oauth2.googleapis.com/device/code` | `oauth2.googleapis.com/token` | `google.com/device` |
| GitHub | `github.com/login/device/code` | `github.com/login/oauth/access_token` | `github.com/login/device` |

*Note: Anthropic and OpenAI URLs are hypothetical - these providers would need to implement
RFC 8628 device authorization. Currently, they only support browser-based OAuth.*

### UI Flow

**Step 1: User clicks "Login with [Provider]"**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Connect Claude Code                                             â”‚
â”‚                                                                  â”‚
â”‚  To connect your Anthropic account:                             â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚  1. Click below to open Anthropic in a new tab             â”‚â”‚
â”‚  â”‚  2. Sign in with your Anthropic account                    â”‚â”‚
â”‚  â”‚  3. Enter the code shown here when prompted                â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚  ðŸ”  Open Anthropic â†’                                       â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Step 2: Show code, user enters at provider**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Connect Claude Code                                             â”‚
â”‚                                                                  â”‚
â”‚  Enter this code at Anthropic:                                  â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚                                                             â”‚â”‚
â”‚  â”‚                    WDJB-MJPV                                â”‚â”‚
â”‚  â”‚                                                             â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                         [Copy]                   â”‚
â”‚                                                                  â”‚
â”‚  A browser tab should have opened to console.anthropic.com     â”‚
â”‚  Didn't open? Click here â†’                                      â”‚
â”‚                                                                  â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚                                                                  â”‚
â”‚  â³ Waiting for you to authorize...                             â”‚
â”‚     Code expires in 14:32                                       â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                               â”‚
â”‚  â”‚    Cancel    â”‚                                               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Same flow for Codex:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Connect OpenAI Codex                                            â”‚
â”‚                                                                  â”‚
â”‚  Enter this code at OpenAI:                                     â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚                                                             â”‚â”‚
â”‚  â”‚                    XKCD-4815                                â”‚â”‚
â”‚  â”‚                                                             â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                         [Copy]                   â”‚
â”‚                                                                  â”‚
â”‚  A browser tab should have opened to auth.openai.com           â”‚
â”‚  Didn't open? Click here â†’                                      â”‚
â”‚                                                                  â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚                                                                  â”‚
â”‚  â³ Waiting for you to authorize...                             â”‚
â”‚     Code expires in 14:47                                       â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                               â”‚
â”‚  â”‚    Cancel    â”‚                                               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Step 3: Success**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                  â”‚
â”‚                    âœ… Connected!                                 â”‚
â”‚                                                                  â”‚
â”‚  Your Anthropic account is now linked.                         â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚  Account: user@example.com                                  â”‚â”‚
â”‚  â”‚  Plan: Claude Pro                                           â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚                     Continue  â†’                             â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Error States:**

```
Code Expired:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  âš ï¸ Code Expired                                                 â”‚
â”‚                                                                  â”‚
â”‚  The authorization code has expired. This happens if you        â”‚
â”‚  don't complete the sign-in within 15 minutes.                  â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Cancel           â”‚  â”‚  Get New Code                    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Access Denied:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  âŒ Access Denied                                                â”‚
â”‚                                                                  â”‚
â”‚  You denied the authorization request at Anthropic.            â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Cancel           â”‚  â”‚  Try Again                       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### Device Flow Implementation

```typescript
// src/cloud/auth/device-flow.ts

interface DeviceCodeResponse {
  device_code: string;        // Secret - we use this for polling
  user_code: string;          // Display to user: "WDJB-MJPV"
  verification_uri: string;   // Where user goes: console.anthropic.com/device
  verification_uri_complete?: string; // URL with code pre-filled (optional)
  expires_in: number;         // Seconds until codes expire (typically 900)
  interval: number;           // Min seconds between poll requests (typically 5)
}

interface DeviceFlowConfig {
  provider: string;
  deviceCodeUrl: string;
  tokenUrl: string;
  clientId: string;
  scopes: string[];
}

const DEVICE_FLOW_CONFIGS: Record<string, DeviceFlowConfig> = {
  anthropic: {
    provider: 'anthropic',
    deviceCodeUrl: 'https://api.anthropic.com/oauth/device/code',
    tokenUrl: 'https://api.anthropic.com/oauth/token',
    clientId: process.env.ANTHROPIC_CLIENT_ID!,
    scopes: ['claude-code:execute', 'user:read']
  },
  openai: {
    provider: 'openai',
    deviceCodeUrl: 'https://auth.openai.com/device/code',
    tokenUrl: 'https://auth.openai.com/oauth/token',
    clientId: process.env.OPENAI_CLIENT_ID!,
    scopes: ['openid', 'profile', 'email', 'codex:execute']
  }
};

class DeviceFlowAuth {
  private config: DeviceFlowConfig;

  constructor(provider: string) {
    this.config = DEVICE_FLOW_CONFIGS[provider];
    if (!this.config) {
      throw new Error(`No device flow config for provider: ${provider}`);
    }
  }

  /**
   * Step 1: Request device and user codes from provider
   */
  async requestCodes(): Promise<DeviceCodeResponse> {
    const response = await fetch(this.config.deviceCodeUrl, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded'
      },
      body: new URLSearchParams({
        client_id: this.config.clientId,
        scope: this.config.scopes.join(' ')
      })
    });

    if (!response.ok) {
      const error = await response.text();
      throw new Error(`Failed to get device code: ${error}`);
    }

    return response.json();
  }

  /**
   * Step 2: Poll for tokens (called repeatedly until success/failure)
   */
  async pollForToken(deviceCode: string): Promise<PollResult> {
    const response = await fetch(this.config.tokenUrl, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded'
      },
      body: new URLSearchParams({
        client_id: this.config.clientId,
        device_code: deviceCode,
        grant_type: 'urn:ietf:params:oauth:grant-type:device_code'
      })
    });

    const data = await response.json();

    // RFC 8628 error codes
    if (data.error) {
      switch (data.error) {
        case 'authorization_pending':
          // User hasn't completed authorization yet
          return { status: 'pending' };

        case 'slow_down':
          // Polling too fast - increase interval
          return {
            status: 'slow_down',
            retryAfter: data.interval || 10
          };

        case 'expired_token':
          // Device code expired
          return { status: 'expired' };

        case 'access_denied':
          // User denied authorization
          return { status: 'denied' };

        default:
          return {
            status: 'error',
            error: data.error_description || data.error
          };
      }
    }

    // Success!
    return {
      status: 'success',
      tokens: {
        accessToken: data.access_token,
        refreshToken: data.refresh_token,
        expiresIn: data.expires_in,
        scope: data.scope
      }
    };
  }
}

type PollResult =
  | { status: 'pending' }
  | { status: 'slow_down'; retryAfter: number }
  | { status: 'expired' }
  | { status: 'denied' }
  | { status: 'error'; error: string }
  | { status: 'success'; tokens: TokenSet };

interface TokenSet {
  accessToken: string;
  refreshToken: string;
  expiresIn: number;
  scope: string;
}
```

### Device Flow API Routes

```typescript
// src/cloud/api/device-flow.ts

const router = Router();

// Store for active device flows (use Redis in production)
const activeFlows = new Map<string, ActiveFlow>();

interface ActiveFlow {
  userId: string;
  provider: string;
  deviceCode: string;
  userCode: string;
  verificationUri: string;
  verificationUriComplete?: string;
  expiresAt: Date;
  pollInterval: number;
  status: 'pending' | 'success' | 'expired' | 'denied' | 'error';
  tokens?: TokenSet;
  error?: string;
}

/**
 * POST /api/device-flow/:provider/start
 * Initiates device flow, returns user code to display
 */
router.post('/:provider/start', async (req, res) => {
  const { provider } = req.params;
  const userId = req.session.userId;

  try {
    const auth = new DeviceFlowAuth(provider);
    const codes = await auth.requestCodes();

    const flowId = crypto.randomUUID();

    activeFlows.set(flowId, {
      userId,
      provider,
      deviceCode: codes.device_code,
      userCode: codes.user_code,
      verificationUri: codes.verification_uri,
      verificationUriComplete: codes.verification_uri_complete,
      expiresAt: new Date(Date.now() + codes.expires_in * 1000),
      pollInterval: codes.interval,
      status: 'pending'
    });

    // Start background polling
    pollInBackground(flowId, auth);

    res.json({
      flowId,
      userCode: codes.user_code,
      verificationUri: codes.verification_uri,
      verificationUriComplete: codes.verification_uri_complete,
      expiresIn: codes.expires_in
    });
  } catch (error) {
    res.status(500).json({ error: error.message });
  }
});

/**
 * GET /api/device-flow/:provider/status/:flowId
 * Check status of device flow (client polls this)
 */
router.get('/:provider/status/:flowId', async (req, res) => {
  const { flowId } = req.params;
  const flow = activeFlows.get(flowId);

  if (!flow) {
    return res.status(404).json({ error: 'Flow not found' });
  }

  if (flow.userId !== req.session.userId) {
    return res.status(403).json({ error: 'Unauthorized' });
  }

  const timeLeft = Math.max(0, Math.floor(
    (flow.expiresAt.getTime() - Date.now()) / 1000
  ));

  res.json({
    status: flow.status,
    expiresIn: timeLeft,
    error: flow.error
  });
});

/**
 * DELETE /api/device-flow/:provider/:flowId
 * Cancel device flow
 */
router.delete('/:provider/:flowId', async (req, res) => {
  const { flowId } = req.params;
  const flow = activeFlows.get(flowId);

  if (flow?.userId === req.session.userId) {
    activeFlows.delete(flowId);
  }

  res.json({ success: true });
});

/**
 * Background polling for device authorization
 */
async function pollInBackground(flowId: string, auth: DeviceFlowAuth) {
  const flow = activeFlows.get(flowId);
  if (!flow) return;

  let interval = flow.pollInterval * 1000;

  const poll = async () => {
    const current = activeFlows.get(flowId);
    if (!current || current.status !== 'pending') return;

    // Check expiry
    if (Date.now() > current.expiresAt.getTime()) {
      current.status = 'expired';
      return;
    }

    try {
      const result = await auth.pollForToken(current.deviceCode);

      switch (result.status) {
        case 'pending':
          setTimeout(poll, interval);
          break;

        case 'slow_down':
          interval = result.retryAfter * 1000;
          setTimeout(poll, interval);
          break;

        case 'success':
          // Store tokens
          await storeProviderTokens(current.userId, current.provider, result.tokens);
          current.status = 'success';
          current.tokens = result.tokens;
          // Clean up after 60s
          setTimeout(() => activeFlows.delete(flowId), 60000);
          break;

        case 'expired':
        case 'denied':
          current.status = result.status;
          break;

        case 'error':
          current.status = 'error';
          current.error = result.error;
          break;
      }
    } catch (error) {
      console.error('Poll error:', error);
      // Retry with backoff
      setTimeout(poll, interval * 2);
    }
  };

  // Start after initial interval
  setTimeout(poll, interval);
}

/**
 * Store tokens after successful device flow
 */
async function storeProviderTokens(
  userId: string,
  provider: string,
  tokens: TokenSet
) {
  // Get user info from provider
  const userInfo = await fetchProviderUserInfo(provider, tokens.accessToken);

  await credentialVault.store({
    userId,
    provider,
    accessToken: tokens.accessToken,
    refreshToken: tokens.refreshToken,
    tokenExpiresAt: new Date(Date.now() + tokens.expiresIn * 1000),
    scopes: tokens.scope.split(' '),
    providerAccountId: userInfo.id,
    providerAccountEmail: userInfo.email,
    providerAccountName: userInfo.name,
    connectedAt: new Date(),
    isValid: true
  });
}
```

### Frontend Component

```tsx
// src/cloud/components/DeviceFlowAuth.tsx

import { useState, useEffect, useCallback } from 'react';

interface Props {
  provider: 'anthropic' | 'openai';
  providerName: string;  // "Anthropic" or "OpenAI"
  onSuccess: () => void;
  onCancel: () => void;
}

type State =
  | { step: 'ready' }
  | { step: 'loading' }
  | { step: 'showing_code'; flowId: string; userCode: string;
      verificationUri: string; expiresAt: Date }
  | { step: 'success' }
  | { step: 'error'; message: string; canRetry: boolean };

export function DeviceFlowAuth({ provider, providerName, onSuccess, onCancel }: Props) {
  const [state, setState] = useState<State>({ step: 'ready' });
  const [timeLeft, setTimeLeft] = useState(0);

  // Start the device flow
  const startFlow = useCallback(async () => {
    setState({ step: 'loading' });

    try {
      const res = await fetch(`/api/device-flow/${provider}/start`, {
        method: 'POST',
        credentials: 'include'
      });
      const data = await res.json();

      if (!res.ok) throw new Error(data.error);

      setState({
        step: 'showing_code',
        flowId: data.flowId,
        userCode: data.userCode,
        verificationUri: data.verificationUri,
        expiresAt: new Date(Date.now() + data.expiresIn * 1000)
      });

      // Open provider auth page
      window.open(
        data.verificationUriComplete || data.verificationUri,
        '_blank',
        'noopener'
      );
    } catch (error) {
      setState({
        step: 'error',
        message: error.message,
        canRetry: true
      });
    }
  }, [provider]);

  // Poll for status
  useEffect(() => {
    if (state.step !== 'showing_code') return;

    const checkStatus = async () => {
      try {
        const res = await fetch(
          `/api/device-flow/${provider}/status/${state.flowId}`,
          { credentials: 'include' }
        );
        const data = await res.json();

        switch (data.status) {
          case 'success':
            setState({ step: 'success' });
            setTimeout(onSuccess, 1500);
            break;
          case 'expired':
            setState({
              step: 'error',
              message: 'Code expired. Please try again.',
              canRetry: true
            });
            break;
          case 'denied':
            setState({
              step: 'error',
              message: 'Authorization was denied.',
              canRetry: true
            });
            break;
          case 'error':
            setState({
              step: 'error',
              message: data.error || 'An error occurred.',
              canRetry: true
            });
            break;
          // 'pending' - keep polling
        }
      } catch (error) {
        console.error('Status check failed:', error);
      }
    };

    const interval = setInterval(checkStatus, 2000);
    return () => clearInterval(interval);
  }, [state, provider, onSuccess]);

  // Countdown timer
  useEffect(() => {
    if (state.step !== 'showing_code') return;

    const tick = () => {
      const remaining = Math.floor(
        (state.expiresAt.getTime() - Date.now()) / 1000
      );
      setTimeLeft(Math.max(0, remaining));
    };

    tick();
    const interval = setInterval(tick, 1000);
    return () => clearInterval(interval);
  }, [state]);

  const formatTime = (s: number) =>
    `${Math.floor(s / 60)}:${(s % 60).toString().padStart(2, '0')}`;

  const copyCode = () => {
    if (state.step === 'showing_code') {
      navigator.clipboard.writeText(state.userCode);
    }
  };

  // Render
  switch (state.step) {
    case 'ready':
      return (
        <div className="device-flow">
          <h2>Connect {providerName}</h2>
          <p>
            Click below to sign in with your {providerName} account.
            You'll enter a code to link your account.
          </p>
          <div className="actions">
            <button onClick={startFlow} className="primary">
              Open {providerName} â†’
            </button>
            <button onClick={onCancel} className="secondary">
              Cancel
            </button>
          </div>
        </div>
      );

    case 'loading':
      return (
        <div className="device-flow loading">
          <div className="spinner" />
          <p>Preparing authorization...</p>
        </div>
      );

    case 'showing_code':
      return (
        <div className="device-flow">
          <h2>Enter this code at {providerName}</h2>

          <div className="code-box">
            <code className="user-code">{state.userCode}</code>
            <button onClick={copyCode} className="copy-btn">
              Copy
            </button>
          </div>

          <p className="hint">
            A browser tab opened to{' '}
            <a href={state.verificationUri} target="_blank" rel="noopener">
              {new URL(state.verificationUri).hostname}
            </a>
          </p>

          <div className="status">
            <span className="spinner small" />
            <span>Waiting for authorization...</span>
          </div>

          <div className="timer">
            Code expires in {formatTime(timeLeft)}
          </div>

          <button onClick={onCancel} className="secondary">
            Cancel
          </button>
        </div>
      );

    case 'success':
      return (
        <div className="device-flow success">
          <div className="icon">âœ…</div>
          <h2>Connected!</h2>
          <p>Your {providerName} account is now linked.</p>
        </div>
      );

    case 'error':
      return (
        <div className="device-flow error">
          <div className="icon">âŒ</div>
          <h2>Connection Failed</h2>
          <p>{state.message}</p>
          <div className="actions">
            {state.canRetry && (
              <button onClick={startFlow} className="primary">
                Try Again
              </button>
            )}
            <button onClick={onCancel} className="secondary">
              Cancel
            </button>
          </div>
        </div>
      );
  }
}
```

---

#### Credential Import (Alternative for Claude)

For users who prefer to authenticate locally first:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Connect Claude Code                                             â”‚
â”‚                                                                  â”‚
â”‚  Choose how to connect:                                         â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚  ðŸ” Login with Anthropic                                    â”‚â”‚
â”‚  â”‚  Authenticate in browser (recommended)                      â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚  ðŸ“ Import from Local Claude                                â”‚â”‚
â”‚  â”‚  Already have Claude Code installed? Import credentials     â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

Import flow:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Import Claude Credentials                                       â”‚
â”‚                                                                  â”‚
â”‚  Run this command on your local machine:                        â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ npx agent-relay-cloud export-credentials                    â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚  [Copy]                                                         â”‚
â”‚                                                                  â”‚
â”‚  This will:                                                     â”‚
â”‚  â€¢ Read your Claude credentials from ~/.claude/                 â”‚
â”‚  â€¢ Encrypt them with a one-time code                           â”‚
â”‚  â€¢ Upload securely to Agent Relay Cloud                        â”‚
â”‚                                                                  â”‚
â”‚  Your credentials never leave your machine unencrypted.        â”‚
â”‚                                                                  â”‚
â”‚  â³ Waiting for import...                                       â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Step 4: Configure Your First Team (Optional)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Create Your First Agent Team                                    â”‚
â”‚                                                                  â”‚
â”‚  Teams are groups of AI agents that work together on tasks.     â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ðŸš€ Quick Start Templates                                â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚                                                          â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚
â”‚  â”‚  â”‚ ðŸ‘¥ Code Review Team                                â”‚ â”‚   â”‚
â”‚  â”‚  â”‚ Architect + Reviewer + Security Auditor            â”‚ â”‚   â”‚
â”‚  â”‚  â”‚ Auto-reviews PRs and suggests improvements         â”‚ â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚
â”‚  â”‚                                                          â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚
â”‚  â”‚  â”‚ ðŸ› ï¸  Feature Development Team                       â”‚ â”‚   â”‚
â”‚  â”‚  â”‚ Lead + Frontend + Backend + Tester                 â”‚ â”‚   â”‚
â”‚  â”‚  â”‚ Coordinates multi-agent feature builds             â”‚ â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚
â”‚  â”‚                                                          â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚
â”‚  â”‚  â”‚ ðŸ“ Custom Team                                     â”‚ â”‚   â”‚
â”‚  â”‚  â”‚ Configure your own agent composition               â”‚ â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚
â”‚  â”‚                                                          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Skip for now â”‚  â”‚  Select template  â†’                     â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Step 5: Ready to Go!

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ðŸŽ‰ You're all set!                                              â”‚
â”‚                                                                  â”‚
â”‚  Your Agent Relay Cloud workspace is ready:                     â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ðŸ“‚ Repositories          2 connected                    â”‚   â”‚
â”‚  â”‚  ðŸ¤– Agent Providers       Claude, Codex                  â”‚   â”‚
â”‚  â”‚  ðŸ‘¥ Teams                 Code Review Team               â”‚   â”‚
â”‚  â”‚  ðŸŒ Dashboard             relay.yourdomain.cloud         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                  â”‚
â”‚  What's next?                                                   â”‚
â”‚                                                                  â”‚
â”‚  â€¢ Open a PR to trigger automatic code review                   â”‚
â”‚  â€¢ Use @agent-relay in PR comments to chat with agents          â”‚
â”‚  â€¢ Visit your dashboard to monitor agent activity               â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Open Dashboard  â†’                                       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Technical Implementation

### Provider Credentials Storage

```typescript
// src/cloud/providers/types.ts

interface ProviderCredential {
  id: string;
  userId: string;
  provider: ProviderType;

  // OAuth tokens (encrypted at rest)
  accessToken: string;
  refreshToken: string;
  tokenExpiresAt: Date;
  scopes: string[];

  // Account info from provider
  providerAccountId: string;    // Provider's user ID
  providerAccountEmail: string; // For display: "user@example.com"
  providerAccountName?: string; // Display name if available

  // Metadata
  connectedAt: Date;
  lastUsedAt?: Date;
  lastRefreshedAt?: Date;
  isValid: boolean;
}

type ProviderType =
  | 'anthropic'    // Claude Code
  | 'openai'       // Codex, ChatGPT
  | 'google'       // Gemini
  | 'github'       // Copilot (auto-connected via signup)
  | 'microsoft'    // Azure OpenAI
  | 'self-hosted'; // Ollama, LM Studio (no auth needed)
```

### Provider Registry

```typescript
// src/cloud/providers/registry.ts

interface OAuthConfig {
  authorizationUrl: string;
  tokenUrl: string;
  scopes: string[];
  userInfoUrl?: string;  // To fetch account email/name after auth
}

interface ProviderConfig {
  id: ProviderType;
  name: string;
  displayName: string;  // "Login with {displayName}"
  description: string;
  cliCommand: string;
  cliArgs?: string[];
  oauthConfig: OAuthConfig;
  icon: string;
  color: string;  // Brand color for button
}

const PROVIDER_REGISTRY: ProviderConfig[] = [
  {
    id: 'anthropic',
    name: 'Anthropic',
    displayName: 'Anthropic',
    description: 'Claude Code - recommended for code tasks',
    cliCommand: 'claude',
    cliArgs: ['--dangerously-skip-permissions'],
    oauthConfig: {
      authorizationUrl: 'https://console.anthropic.com/oauth/authorize',
      tokenUrl: 'https://api.anthropic.com/oauth/token',
      scopes: ['claude-code:execute', 'user:read'],
      userInfoUrl: 'https://api.anthropic.com/v1/user'
    },
    icon: 'anthropic-logo.svg',
    color: '#D97757'
  },
  {
    id: 'openai',
    name: 'OpenAI',
    displayName: 'OpenAI',
    description: 'Codex and ChatGPT models',
    cliCommand: 'codex',
    cliArgs: ['--dangerously-bypass-approvals-and-sandbox'],
    oauthConfig: {
      authorizationUrl: 'https://auth.openai.com/authorize',
      tokenUrl: 'https://auth.openai.com/oauth/token',
      scopes: ['openid', 'profile', 'email', 'model.read', 'model.request'],
      userInfoUrl: 'https://api.openai.com/v1/user'
    },
    icon: 'openai-logo.svg',
    color: '#10A37F'
  },
  {
    id: 'google',
    name: 'Google',
    displayName: 'Google',
    description: 'Gemini - multi-modal capabilities',
    cliCommand: 'gemini',
    oauthConfig: {
      authorizationUrl: 'https://accounts.google.com/o/oauth2/v2/auth',
      tokenUrl: 'https://oauth2.googleapis.com/token',
      scopes: [
        'openid',
        'email',
        'profile',
        'https://www.googleapis.com/auth/generative-language'
      ],
      userInfoUrl: 'https://www.googleapis.com/oauth2/v2/userinfo'
    },
    icon: 'google-logo.svg',
    color: '#4285F4'
  },
  {
    id: 'github',
    name: 'GitHub',
    displayName: 'GitHub',
    description: 'Copilot - auto-connected via signup',
    cliCommand: 'gh-copilot',
    oauthConfig: {
      // Uses same OAuth from signup - just needs Copilot scope
      authorizationUrl: 'https://github.com/login/oauth/authorize',
      tokenUrl: 'https://github.com/login/oauth/access_token',
      scopes: ['copilot', 'read:user', 'user:email'],
      userInfoUrl: 'https://api.github.com/user'
    },
    icon: 'github-logo.svg',
    color: '#24292F'
  },
  {
    id: 'microsoft',
    name: 'Microsoft',
    displayName: 'Microsoft',
    description: 'Azure OpenAI - enterprise deployments',
    cliCommand: 'azure-openai',
    oauthConfig: {
      authorizationUrl: 'https://login.microsoftonline.com/common/oauth2/v2.0/authorize',
      tokenUrl: 'https://login.microsoftonline.com/common/oauth2/v2.0/token',
      scopes: [
        'openid',
        'profile',
        'email',
        'https://cognitiveservices.azure.com/.default'
      ],
      userInfoUrl: 'https://graph.microsoft.com/v1.0/me'
    },
    icon: 'microsoft-logo.svg',
    color: '#00A4EF'
  }
];

// Self-hosted providers don't need OAuth
interface SelfHostedProvider {
  id: 'self-hosted';
  name: string;
  endpoint: string;  // e.g., "http://localhost:11434" for Ollama
  cliCommand: string;
}
```

### Spawner Integration

```typescript
// src/cloud/spawner-cloud.ts

class CloudAgentSpawner extends AgentSpawner {
  private credentialVault: CredentialVault;
  private tokenRefresher: TokenRefresher;

  async spawn(request: CloudSpawnRequest): Promise<SpawnedAgent> {
    const { userId, provider, agentName, task } = request;

    // Get credentials for this provider
    const credential = await this.credentialVault.get(userId, provider);
    if (!credential) {
      throw new ProviderNotConnectedError(provider);
    }

    // Refresh token if expired or expiring soon (within 5 min)
    const validCredential = await this.ensureValidToken(credential);

    // Build environment with OAuth token
    const env = this.buildProviderEnv(validCredential);

    // Get provider config
    const providerConfig = PROVIDER_REGISTRY.find(p => p.id === provider);

    // Spawn agent with credentials injected
    return super.spawn({
      name: agentName,
      cli: providerConfig.cliCommand,
      args: providerConfig.cliArgs,
      env,
      task
    });
  }

  private async ensureValidToken(credential: ProviderCredential): Promise<ProviderCredential> {
    const expiresIn = credential.tokenExpiresAt.getTime() - Date.now();
    const FIVE_MINUTES = 5 * 60 * 1000;

    if (expiresIn < FIVE_MINUTES) {
      // Refresh the token
      const provider = PROVIDER_REGISTRY.find(p => p.id === credential.provider);
      const newTokens = await this.tokenRefresher.refresh(
        provider.oauthConfig,
        credential.refreshToken
      );

      // Update stored credential
      const updated = await this.credentialVault.update(credential.id, {
        accessToken: newTokens.accessToken,
        refreshToken: newTokens.refreshToken ?? credential.refreshToken,
        tokenExpiresAt: newTokens.expiresAt,
        lastRefreshedAt: new Date()
      });

      return updated;
    }

    return credential;
  }

  private buildProviderEnv(credential: ProviderCredential): Record<string, string> {
    // Each provider expects OAuth token in different env vars
    const envMapping: Record<ProviderType, string> = {
      'anthropic': 'ANTHROPIC_AUTH_TOKEN',
      'openai': 'OPENAI_AUTH_TOKEN',
      'google': 'GOOGLE_AUTH_TOKEN',
      'github': 'GITHUB_TOKEN',
      'microsoft': 'AZURE_AUTH_TOKEN',
      'self-hosted': '' // No auth needed
    };

    const envVar = envMapping[credential.provider];
    if (!envVar) return {};

    return {
      [envVar]: credential.accessToken,
      // Some CLIs also want the account info
      'PROVIDER_ACCOUNT_EMAIL': credential.providerAccountEmail
    };
  }
}

class ProviderNotConnectedError extends Error {
  constructor(provider: ProviderType) {
    super(`Provider "${provider}" is not connected. Please connect it in Settings.`);
    this.name = 'ProviderNotConnectedError';
  }
}
```

### Onboarding API

```typescript
// src/cloud/api/onboarding.ts

const onboardingRouter = Router();

// Step 1: GitHub OAuth callback (primary signup/login)
onboardingRouter.get('/auth/github/callback', async (req, res) => {
  const { code } = req.query;
  const tokens = await exchangeGitHubCode(code);
  const user = await createOrUpdateUser(tokens);

  // Store GitHub credential (also gives us Copilot access)
  await credentialVault.store({
    userId: user.id,
    provider: 'github',
    accessToken: tokens.accessToken,
    refreshToken: tokens.refreshToken,
    tokenExpiresAt: tokens.expiresAt,
    scopes: tokens.scopes,
    providerAccountId: tokens.user.id,
    providerAccountEmail: tokens.user.email,
    providerAccountName: tokens.user.name,
    connectedAt: new Date(),
    isValid: true
  });

  // Set session and redirect to repo selection
  req.session.userId = user.id;
  res.redirect('/onboarding/repositories');
});

// Step 2: Get user's repositories
onboardingRouter.get('/repositories', async (req, res) => {
  const repos = await github.listUserRepos(req.session.accessToken);
  res.json({ repos });
});

// Step 2: Connect selected repositories
onboardingRouter.post('/repositories', async (req, res) => {
  const { repoIds } = req.body;
  await Promise.all(repoIds.map(id =>
    connectRepository(req.session.userId, id)
  ));
  res.json({ success: true });
});

// Step 3: List available providers with connection status
onboardingRouter.get('/providers', async (req, res) => {
  const connected = await getConnectedProviders(req.session.userId);

  // Map registry with connection status
  const providers = PROVIDER_REGISTRY.map(p => ({
    ...p,
    isConnected: connected.some(c => c.provider === p.id),
    connectedAs: connected.find(c => c.provider === p.id)?.providerAccountEmail
  }));

  res.json({ providers });
});

// Step 3: Initiate OAuth login for a provider
onboardingRouter.get('/providers/:provider/login', async (req, res) => {
  const { provider } = req.params;
  const config = PROVIDER_REGISTRY.find(p => p.id === provider);

  if (!config) {
    return res.status(404).json({ error: 'Unknown provider' });
  }

  // Generate state token for CSRF protection
  const state = await generateOAuthState({
    userId: req.session.userId,
    provider,
    returnTo: req.query.returnTo || '/onboarding/providers'
  });

  // Build OAuth authorization URL
  const authUrl = new URL(config.oauthConfig.authorizationUrl);
  authUrl.searchParams.set('client_id', getClientId(provider));
  authUrl.searchParams.set('redirect_uri', `${BASE_URL}/providers/${provider}/callback`);
  authUrl.searchParams.set('scope', config.oauthConfig.scopes.join(' '));
  authUrl.searchParams.set('state', state);
  authUrl.searchParams.set('response_type', 'code');

  res.redirect(authUrl.toString());
});

// Step 3: OAuth callback after user authorizes
onboardingRouter.get('/providers/:provider/callback', async (req, res) => {
  const { code, state, error } = req.query;

  if (error) {
    return res.redirect(`/onboarding/providers?error=${error}`);
  }

  // Verify state token
  const stateData = await verifyOAuthState(state);
  if (!stateData) {
    return res.status(400).json({ error: 'Invalid state' });
  }

  const { userId, provider, returnTo } = stateData;
  const config = PROVIDER_REGISTRY.find(p => p.id === provider);

  // Exchange code for tokens
  const tokens = await exchangeOAuthCode({
    tokenUrl: config.oauthConfig.tokenUrl,
    code,
    clientId: getClientId(provider),
    clientSecret: getClientSecret(provider),
    redirectUri: `${BASE_URL}/providers/${provider}/callback`
  });

  // Fetch user info from provider
  const userInfo = await fetchProviderUserInfo(
    config.oauthConfig.userInfoUrl,
    tokens.accessToken
  );

  // Store credential
  await credentialVault.store({
    userId,
    provider,
    accessToken: tokens.accessToken,
    refreshToken: tokens.refreshToken,
    tokenExpiresAt: new Date(Date.now() + tokens.expiresIn * 1000),
    scopes: tokens.scope.split(' '),
    providerAccountId: userInfo.id,
    providerAccountEmail: userInfo.email,
    providerAccountName: userInfo.name,
    connectedAt: new Date(),
    isValid: true
  });

  res.redirect(`${returnTo}?connected=${provider}`);
});

// Step 3: Disconnect a provider
onboardingRouter.delete('/providers/:provider', async (req, res) => {
  const { provider } = req.params;

  await credentialVault.delete(req.session.userId, provider);

  res.json({ success: true });
});

// Step 4: Create team from template
onboardingRouter.post('/teams/from-template', async (req, res) => {
  const { templateId, repoIds, defaultProvider } = req.body;
  const template = TEAM_TEMPLATES[templateId];

  // Verify user has the default provider connected
  const hasProvider = await credentialVault.exists(
    req.session.userId,
    defaultProvider || 'anthropic'
  );

  if (!hasProvider) {
    return res.status(400).json({
      error: 'Provider not connected',
      message: `Please connect ${defaultProvider || 'Anthropic'} first`
    });
  }

  const team = await createTeam({
    userId: req.session.userId,
    name: template.name,
    agents: template.agents.map(a => ({
      ...a,
      provider: defaultProvider || 'anthropic'
    })),
    repoIds
  });

  res.json({ team });
});

// Complete onboarding
onboardingRouter.post('/complete', async (req, res) => {
  await markOnboardingComplete(req.session.userId);

  // Provision workspace
  const workspace = await provisionWorkspace(req.session.userId);

  res.json({
    dashboardUrl: workspace.dashboardUrl,
    webhookUrl: workspace.webhookUrl
  });
});
```

---

## Security Considerations

### OAuth Token Security

1. **Encryption at rest**: All tokens encrypted with AES-256-GCM
2. **Key derivation**: Per-user encryption keys derived from master key + user ID
3. **No plaintext logging**: Tokens never logged, even in debug mode
4. **Short-lived access tokens**: Rely on refresh tokens for long sessions

### Token Lifecycle Management

1. **Automatic refresh**: Tokens refreshed 5 minutes before expiry
2. **Refresh token rotation**: Use rotating refresh tokens where supported
3. **Revocation detection**: Check token validity on spawn, prompt re-auth if revoked
4. **Graceful degradation**: Queue tasks if token refresh fails temporarily

### Scope Management

1. **Minimum scopes**: Request only scopes needed for agent execution
2. **Scope display**: Show users exactly what permissions we request
3. **No scope creep**: Never silently request additional scopes

### Access Control

1. **User isolation**: Credentials tied to user ID, never shared
2. **Team permissions**: Team admins can enable provider access for team members
3. **Audit logging**: All credential access and agent spawns logged
4. **Rate limiting**: Provider usage rate-limited per user/team

---

## Future Enhancements

### 1. Credential Sharing for Teams

Allow team admins to share provider credentials with team members:

```typescript
interface SharedCredential {
  credentialId: string;
  teamId: string;
  sharedBy: string;
  permissions: 'read' | 'use';  // 'use' allows spawning agents
}
```

### 2. Usage Tracking & Billing

Track provider usage per user/team for billing:

```typescript
interface UsageRecord {
  userId: string;
  teamId?: string;
  provider: ProviderType;
  agentName: string;
  tokensUsed: number;
  duration: number;
  timestamp: Date;
}
```

### 3. Provider Health Monitoring

Monitor provider availability and quota:

```typescript
interface ProviderHealth {
  provider: ProviderType;
  status: 'healthy' | 'degraded' | 'down';
  quotaRemaining?: number;
  lastChecked: Date;
}
```

### 4. Bring Your Own Cloud

Let users connect their own cloud accounts for compute:

- AWS credentials for EC2 instances
- GCP credentials for Cloud Run
- Azure credentials for Container Instances

---

## Summary

The onboarding flow prioritizes:

1. **Low friction**: GitHub OAuth gets users started immediately
2. **Consistent UX**: All providers use "Login with X" - no API keys to manage
3. **Security**: OAuth tokens with automatic refresh, encrypted at rest
4. **Account linking**: Users log in with their existing provider accounts
5. **Progressive disclosure**: Optional team setup, can skip and add later
6. **Graceful recovery**: Re-auth prompts when tokens expire or get revoked

Users can connect all their AI providers during onboarding with simple login buttons, or add them later from Settings. GitHub Copilot is auto-connected via the initial signup flow.

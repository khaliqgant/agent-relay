# Agent Relay Cloud - Local Development Setup
# Run with: docker compose -f docker-compose.dev.yml up
#
# This starts the full cloud stack locally:
# - PostgreSQL database
# - Redis for sessions/caching
# - Cloud API server
# - Example workspace (optional)
#
# After starting, access:
# - Landing page: http://localhost:4567
# - Dashboard: http://localhost:4567/dashboard
# - API: http://localhost:4567/api

version: '3.8'

services:
  # PostgreSQL database
  postgres:
    image: postgres:16-alpine
    environment:
      POSTGRES_USER: agent_relay
      POSTGRES_PASSWORD: dev_password
      POSTGRES_DB: agent_relay
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./deploy/init-db.sql:/docker-entrypoint-initdb.d/init.sql:ro
    ports:
      - "5433:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U agent_relay"]
      interval: 5s
      timeout: 5s
      retries: 5

  # Redis for sessions and pub/sub
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 5s
      retries: 5

  # Cloud API server
  cloud:
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "4567:4567"
    environment:
      NODE_ENV: development
      PORT: 4567
      PUBLIC_URL: http://localhost:4567

      # Database
      DATABASE_URL: postgres://agent_relay:dev_password@postgres:5432/agent_relay
      REDIS_URL: redis://redis:6379

      # Session (generate your own for production!)
      SESSION_SECRET: dev-session-secret-change-in-production

      # GitHub OAuth (set these in .env.local)
      GITHUB_CLIENT_ID: ${GITHUB_CLIENT_ID:-}
      GITHUB_CLIENT_SECRET: ${GITHUB_CLIENT_SECRET:-}

      # Nango (set in .env.local - get from Nango dashboard)
      NANGO_SECRET_KEY: ${NANGO_SECRET_KEY:-}

      # Vault master key (generate with: openssl rand -base64 32)
      # Default is "dev-vault-key-32-bytes-change!!!" - MUST be exactly 32 bytes when decoded
      VAULT_MASTER_KEY: ${VAULT_MASTER_KEY:-ZGV2LXZhdWx0LWtleS0zMi1ieXRlcy1jaGFuZ2UhISE=}

      # Stripe (set in .env.local for billing features)
      STRIPE_SECRET_KEY: ${STRIPE_SECRET_KEY:-sk_test_placeholder}
      STRIPE_PUBLISHABLE_KEY: ${STRIPE_PUBLISHABLE_KEY:-pk_test_placeholder}
      STRIPE_WEBHOOK_SECRET: ${STRIPE_WEBHOOK_SECRET:-whsec_placeholder}

      # Compute provider (docker for local dev)
      COMPUTE_PROVIDER: docker

      # Flag to indicate we're running in Docker (for localhost translation)
      RUNNING_IN_DOCKER: "true"

      # Force cloud mode in dashboard (prevents silent fallback to local mode)
      NEXT_PUBLIC_FORCE_CLOUD_MODE: "true"

      # Provider OAuth (optional)
      GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID:-}
      GOOGLE_CLIENT_SECRET: ${GOOGLE_CLIENT_SECRET:-}
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    volumes:
      # Mount docker socket for local workspace provisioning
      - /var/run/docker.sock:/var/run/docker.sock
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4567/health"]
      interval: 10s
      timeout: 5s
      retries: 3

  # Optional: Example workspace for testing
  workspace:
    image: ghcr.io/agentworkforce/relay-workspace:latest
    build:
      context: .
      dockerfile: deploy/workspace/Dockerfile
    user: root  # Required to start SSH server before dropping privileges
    ports:
      - "3888:3888"
      - "3889:3889"
      - "2222:2222"  # SSH for port forwarding (e.g., Codex OAuth)
    environment:
      WORKSPACE_ID: local-dev-workspace
      SUPERVISOR_ENABLED: "true"
      MAX_AGENTS: "10"
      # SSH for port forwarding (Codex OAuth callback tunneling)
      ENABLE_SSH: "true"
      SSH_PASSWORD: ${WORKSPACE_SSH_PASSWORD:-devpassword}
    volumes:
      - workspace_data:/data
      - ./:/workspace:ro
    profiles:
      - workspace
    depends_on:
      - cloud

volumes:
  postgres_data:
  redis_data:
  workspace_data:

networks:
  default:
    name: agent-relay-dev
